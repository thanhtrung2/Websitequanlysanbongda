<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th√¥ng tin c√° nh√¢n</title>
  <link rel="stylesheet" href="../css/tailwind-fallback.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <nav class="bg-gradient-to-r from-green-600 to-green-700 text-white shadow-xl">
    <div class="container mx-auto px-4 py-4">
      <div class="flex justify-between items-center">
        <a href="../index.html" class="flex items-center space-x-3">
          <span class="text-4xl">‚öΩ</span>
          <div>
            <h1 class="text-2xl font-bold">Th√†nh Trung M10</h1>
            <p class="text-xs text-green-100">Th√¥ng tin c√° nh√¢n</p>
          </div>
        </a>
        <div class="hidden md:flex items-center gap-6">
          <a href="../index.html" class="text-white/80 hover:text-white transition font-medium">Trang ch·ªß</a>
          <a href="../san-bong.html" class="text-white/80 hover:text-white transition font-medium">S√¢n b√≥ng</a>
          <a href="shop.html" class="text-white/80 hover:text-white transition font-medium">C·ª≠a h√†ng</a>
          <a href="community.html" class="text-white/80 hover:text-white transition font-medium">C·ªông ƒë·ªìng</a>
          <a href="about.html" class="text-white/80 hover:text-white transition font-medium">Gi·ªõi thi·ªáu</a>
          <a href="contact.html" class="text-white/80 hover:text-white transition font-medium">Li√™n h·ªá</a>
          <div id="userMenu"></div>
        </div>
        <button onclick="toggleMobileMenu()" class="md:hidden text-white text-2xl">‚ò∞</button>
      </div>
      <div id="mobileMenu" class="hidden md:hidden mt-4 pb-4 border-t border-white/20 pt-4">
        <div class="flex flex-col gap-3">
          <a href="../index.html" class="text-white/80 hover:text-white transition">Trang ch·ªß</a>
          <a href="../san-bong.html" class="text-white/80 hover:text-white transition">S√¢n b√≥ng</a>
          <a href="shop.html" class="text-white/80 hover:text-white transition">C·ª≠a h√†ng</a>
          <a href="community.html" class="text-white/80 hover:text-white transition">C·ªông ƒë·ªìng</a>
          <a href="about.html" class="text-white/80 hover:text-white transition">Gi·ªõi thi·ªáu</a>
          <a href="contact.html" class="text-white/80 hover:text-white transition">Li√™n h·ªá</a>
          <div id="mobileUserMenu" class="flex flex-col gap-2 mt-2 pt-2 border-t border-white/20"></div>
        </div>
      </div>
    </div>
  </nav>

  <div class="container mx-auto px-4 py-8">
    <div class="max-w-6xl mx-auto">
      <h2 class="text-3xl font-bold mb-8">Th√¥ng tin c√° nh√¢n</h2>
      
      <div class="grid md:grid-cols-3 gap-6 mb-8">
        <!-- Profile Card -->
        <div class="md:col-span-1">
          <div class="bg-white rounded-lg shadow-md p-6 text-center">
            <div id="avatar" class="w-24 h-24 bg-green-500 rounded-full mx-auto mb-4 flex items-center justify-center text-white text-4xl font-bold">
              ?
            </div>
            <h3 id="userName" class="text-xl font-bold mb-2">ƒêang t·∫£i...</h3>
            <p id="userRole" class="text-gray-600 mb-4">Kh√°ch h√†ng</p>
            <button onclick="openEditModal()" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition">
              ‚úèÔ∏è Ch·ªânh s·ª≠a th√¥ng tin
            </button>
          </div>

          <!-- Stats Card -->
          <div class="bg-white rounded-lg shadow-md p-6 mt-6">
            <h4 class="font-bold text-lg mb-4">Th·ªëng k√™</h4>
            <div class="space-y-3">
              <div class="flex justify-between items-center">
                <span class="text-gray-600">T·ªïng ƒë·∫∑t s√¢n</span>
                <span id="totalBookings" class="font-bold text-green-600">0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">ƒê√£ ho√†n th√†nh</span>
                <span id="completedBookings" class="font-bold text-blue-600">0</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-gray-600">T·ªïng chi ti√™u</span>
                <span id="totalSpent" class="font-bold text-orange-600">0ƒë</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Info Details -->
        <div class="md:col-span-2">
          <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h4 class="text-xl font-semibold mb-4">Chi ti·∫øt th√¥ng tin</h4>
            <div class="space-y-4">
              <div class="border-b pb-3">
                <label class="text-gray-600 text-sm">H·ªç v√† t√™n</label>
                <p id="profileName" class="font-semibold text-lg">ƒêang t·∫£i...</p>
              </div>
              <div class="border-b pb-3">
                <label class="text-gray-600 text-sm">Email</label>
                <p id="profileEmail" class="font-semibold text-lg">ƒêang t·∫£i...</p>
              </div>
              <div class="border-b pb-3">
                <label class="text-gray-600 text-sm">S·ªë ƒëi·ªán tho·∫°i</label>
                <p id="profilePhone" class="font-semibold text-lg">ƒêang t·∫£i...</p>
              </div>
              <div class="border-b pb-3">
                <label class="text-gray-600 text-sm">Vai tr√≤</label>
                <p id="profileRoleDetail" class="font-semibold text-lg">ƒêang t·∫£i...</p>
              </div>
              <div class="pb-3">
                <label class="text-gray-600 text-sm">Ng√†y tham gia</label>
                <p id="profileCreatedAt" class="font-semibold text-lg">ƒêang t·∫£i...</p>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="bg-white rounded-lg shadow-md p-6">
            <h4 class="text-xl font-semibold mb-4">Thao t√°c nhanh</h4>
            <div class="grid grid-cols-2 gap-4">
              <a href="fields.html" class="flex items-center justify-center gap-2 bg-green-500 text-white py-3 rounded-lg hover:bg-green-600 transition">
                <span>‚öΩ</span> ƒê·∫∑t s√¢n m·ªõi
              </a>
              <button onclick="scrollToBookings()" class="flex items-center justify-center gap-2 bg-blue-500 text-white py-3 rounded-lg hover:bg-blue-600 transition">
                <span>üìÖ</span> L·ªãch ƒë·∫∑t s√¢n
              </button>
              <button onclick="openChangePassword()" class="flex items-center justify-center gap-2 bg-purple-500 text-white py-3 rounded-lg hover:bg-purple-600 transition">
                <span>üîí</span> ƒê·ªïi m·∫≠t kh·∫©u
              </button>
              <a href="../index.html" class="flex items-center justify-center gap-2 bg-gray-500 text-white py-3 rounded-lg hover:bg-gray-600 transition">
                <span>üè†</span> Trang ch·ªß
              </a>
            </div>
          </div>
        </div>
      </div>

      <!-- Booking History -->
      <div class="bg-white rounded-lg shadow-md p-6" id="bookingSection">
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-2xl font-bold">L·ªãch s·ª≠ ƒë·∫∑t s√¢n</h3>
          <div class="flex gap-2">
            <button onclick="filterBookings('all')" class="filter-btn px-4 py-2 rounded-lg bg-green-600 text-white text-sm">T·∫•t c·∫£</button>
            <button onclick="filterBookings('pending')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-sm">Ch·ªù x√°c nh·∫≠n</button>
            <button onclick="filterBookings('confirmed')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-sm">ƒê√£ x√°c nh·∫≠n</button>
            <button onclick="filterBookings('completed')" class="filter-btn px-4 py-2 rounded-lg bg-gray-200 text-sm">Ho√†n th√†nh</button>
          </div>
        </div>
        <div id="bookingHistory" class="space-y-4">
          <p class="text-gray-500">ƒêang t·∫£i l·ªãch s·ª≠...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Profile Modal -->
  <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
      <h3 class="text-xl font-bold mb-4">Ch·ªânh s·ª≠a th√¥ng tin</h3>
      <form id="editForm">
        <div class="mb-4">
          <label class="block text-gray-700 font-semibold mb-2">H·ªç v√† t√™n</label>
          <input type="text" id="editName" required class="w-full px-4 py-2 border rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 font-semibold mb-2">S·ªë ƒëi·ªán tho·∫°i</label>
          <input type="tel" id="editPhone" required class="w-full px-4 py-2 border rounded-lg">
        </div>
        <div class="flex gap-4">
          <button type="submit" class="flex-1 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700">
            L∆∞u
          </button>
          <button type="button" onclick="closeEditModal()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
            H·ªßy
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="passwordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
      <h3 class="text-xl font-bold mb-4">ƒê·ªïi m·∫≠t kh·∫©u</h3>
      <form id="passwordForm">
        <div class="mb-4">
          <label class="block text-gray-700 font-semibold mb-2">M·∫≠t kh·∫©u hi·ªán t·∫°i</label>
          <input type="password" id="currentPassword" required class="w-full px-4 py-2 border rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 font-semibold mb-2">M·∫≠t kh·∫©u m·ªõi</label>
          <input type="password" id="newPassword" required class="w-full px-4 py-2 border rounded-lg">
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 font-semibold mb-2">X√°c nh·∫≠n m·∫≠t kh·∫©u m·ªõi</label>
          <input type="password" id="confirmPassword" required class="w-full px-4 py-2 border rounded-lg">
        </div>
        <div class="flex gap-4">
          <button type="submit" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">
            ƒê·ªïi m·∫≠t kh·∫©u
          </button>
          <button type="button" onclick="closePasswordModal()" class="flex-1 bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
            H·ªßy
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="../js/main.js"></script>
  <script>
    // API_URL ƒë√£ ƒë∆∞·ª£c khai b√°o trong main.js
    
    // Check login
    const token = localStorage.getItem('token');
    if (!token) {
      alert('Vui l√≤ng ƒëƒÉng nh·∫≠p');
      window.location.href = 'login.html';
    }
    
    let currentUser = null;
    let allBookings = [];
    let currentFilter = 'all';
    
    // Logout function
    function logout() {
      localStorage.clear();
      window.location.href = '../index.html';
    }
    
    // Load profile
    async function loadProfile() {
      try {
        const response = await fetch(`${API_URL}/users/profile`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (!response.ok) throw new Error('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin');
        
        currentUser = await response.json();
        displayProfile(currentUser);
      } catch (error) {
        console.error('Error:', error);
        alert('L·ªói t·∫£i th√¥ng tin. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.');
        localStorage.clear();
        window.location.href = 'login.html';
      }
    }

    function displayProfile(user) {
      const initial = user.name.charAt(0).toUpperCase();
      document.getElementById('avatar').textContent = initial;
      document.getElementById('userName').textContent = user.name;
      document.getElementById('profileName').textContent = user.name;
      document.getElementById('profileEmail').textContent = user.email;
      document.getElementById('profilePhone').textContent = user.phone || 'Ch∆∞a c·∫≠p nh·∫≠t';
      
      const roleMap = {
        'customer': 'Kh√°ch h√†ng',
        'admin': 'Qu·∫£n tr·ªã vi√™n',
        'staff': 'Nh√¢n vi√™n'
      };
      const roleName = roleMap[user.role] || 'Kh√°ch h√†ng';
      document.getElementById('userRole').textContent = roleName;
      document.getElementById('profileRoleDetail').textContent = roleName;
      
      if (user.createdAt) {
        const date = new Date(user.createdAt);
        document.getElementById('profileCreatedAt').textContent = date.toLocaleDateString('vi-VN', {
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }
    }

    // Load booking history
    async function loadBookingHistory() {
      try {
        const response = await fetch(`${API_URL}/bookings/my-bookings`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        if (response.ok) {
          allBookings = await response.json();
          updateStats();
          displayBookings();
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function updateStats() {
      const total = allBookings.length;
      const completed = allBookings.filter(b => b.status === 'completed').length;
      const totalSpent = allBookings
        .filter(b => b.status !== 'cancelled')
        .reduce((sum, b) => sum + b.totalPrice, 0);
      
      document.getElementById('totalBookings').textContent = total;
      document.getElementById('completedBookings').textContent = completed;
      document.getElementById('totalSpent').textContent = totalSpent.toLocaleString('vi-VN') + 'ƒë';
    }

    function filterBookings(status) {
      currentFilter = status;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('bg-green-600', 'text-white');
        btn.classList.add('bg-gray-200');
      });
      event.target.classList.remove('bg-gray-200');
      event.target.classList.add('bg-green-600', 'text-white');
      
      displayBookings();
    }

    function displayBookings() {
      const container = document.getElementById('bookingHistory');
      
      let filtered = allBookings;
      if (currentFilter !== 'all') {
        filtered = allBookings.filter(b => b.status === currentFilter);
      }
      
      filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
      
      if (filtered.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Kh√¥ng c√≥ l·ªãch ƒë·∫∑t n√†o</p>';
        return;
      }

      const statusColors = {
        'pending': 'bg-yellow-100 text-yellow-800',
        'confirmed': 'bg-green-100 text-green-800',
        'completed': 'bg-blue-100 text-blue-800',
        'cancelled': 'bg-red-100 text-red-800'
      };

      const statusText = {
        'pending': 'Ch·ªù x√°c nh·∫≠n',
        'confirmed': 'ƒê√£ x√°c nh·∫≠n',
        'completed': 'Ho√†n th√†nh',
        'cancelled': 'ƒê√£ h·ªßy'
      };

      container.innerHTML = filtered.map(booking => {
        const bookingDate = new Date(booking.date);
        const isPast = bookingDate < new Date();
        const canCancel = (booking.status === 'pending' || booking.status === 'confirmed') && !isPast;
        
        return `
          <div class="border rounded-lg p-4 hover:shadow-md transition">
            <div class="flex justify-between items-start mb-3">
              <div class="flex-1">
                <h4 class="font-bold text-lg text-gray-800">${booking.field?.name || 'S√¢n b√≥ng'}</h4>
                <p class="text-gray-600 text-sm">${booking.field?.location?.address || ''}</p>
              </div>
              <span class="px-3 py-1 rounded-full text-xs font-semibold ${statusColors[booking.status]}">
                ${statusText[booking.status]}
              </span>
            </div>
            
            <div class="grid md:grid-cols-3 gap-3 mb-3">
              <div>
                <p class="text-gray-500 text-sm">Ng√†y ƒë·∫∑t</p>
                <p class="font-semibold">${bookingDate.toLocaleDateString('vi-VN')}</p>
              </div>
              <div>
                <p class="text-gray-500 text-sm">Gi·ªù</p>
                <p class="font-semibold">${booking.startTime} - ${booking.endTime}</p>
              </div>
              <div>
                <p class="text-gray-500 text-sm">T·ªïng ti·ªÅn</p>
                <p class="font-semibold text-green-600">${booking.totalPrice.toLocaleString('vi-VN')}ƒë</p>
              </div>
            </div>

            ${canCancel ? `
              <button onclick="cancelBooking('${booking._id}')" 
                class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 text-sm">
                H·ªßy ƒë·∫∑t s√¢n
              </button>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    async function cancelBooking(bookingId) {
      if (!confirm('B·∫°n c√≥ ch·∫Øc mu·ªën h·ªßy ƒë·∫∑t s√¢n n√†y?')) return;
      
      try {
        const response = await fetch(`${API_URL}/bookings/${bookingId}/status`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ status: 'cancelled' })
        });

        if (response.ok) {
          alert('ƒê√£ h·ªßy ƒë·∫∑t s√¢n th√†nh c√¥ng!');
          loadBookingHistory();
        } else {
          alert('L·ªói khi h·ªßy ƒë·∫∑t s√¢n');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('L·ªói k·∫øt n·ªëi server');
      }
    }

    // Edit profile modal
    function openEditModal() {
      document.getElementById('editName').value = currentUser.name;
      document.getElementById('editPhone').value = currentUser.phone || '';
      document.getElementById('editModal').classList.remove('hidden');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.add('hidden');
    }

    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const data = {
        name: document.getElementById('editName').value,
        phone: document.getElementById('editPhone').value
      };

      try {
        const response = await fetch(`${API_URL}/users/profile`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          alert('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!');
          closeEditModal();
          loadProfile();
        } else {
          alert('L·ªói c·∫≠p nh·∫≠t th√¥ng tin');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('L·ªói k·∫øt n·ªëi server');
      }
    });

    // Change password modal
    function openChangePassword() {
      document.getElementById('passwordModal').classList.remove('hidden');
    }

    function closePasswordModal() {
      document.getElementById('passwordModal').classList.add('hidden');
      document.getElementById('passwordForm').reset();
    }

    document.getElementById('passwordForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      if (newPassword !== confirmPassword) {
        alert('M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp!');
        return;
      }

      if (newPassword.length < 6) {
        alert('M·∫≠t kh·∫©u m·ªõi ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±!');
        return;
      }

      try {
        const response = await fetch(`${API_URL}/auth/change-password`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ currentPassword, newPassword })
        });

        const data = await response.json();

        if (response.ok) {
          alert('ƒê·ªïi m·∫≠t kh·∫©u th√†nh c√¥ng!');
          closePasswordModal();
        } else {
          alert(data.message || 'L·ªói ƒë·ªïi m·∫≠t kh·∫©u');
        }
      } catch (error) {
        console.error('Error:', error);
        alert('L·ªói k·∫øt n·ªëi server');
      }
    });

    function scrollToBookings() {
      document.getElementById('bookingSection').scrollIntoView({ behavior: 'smooth' });
    }

    // Load data
    loadProfile();
    loadBookingHistory();
  </script>
</body>
</html>
