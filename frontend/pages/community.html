<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C·ªông ƒë·ªìng - Th√†nh Trung M10</title>
  <link rel="stylesheet" href="../css/tailwind-fallback.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50">
  <!-- Navigation -->
  <nav class="bg-gradient-to-r from-green-600 to-green-700 text-white shadow-xl">
    <div class="container mx-auto px-4 py-4">
      <div class="flex justify-between items-center">
        <a href="../index.html" class="flex items-center space-x-3">
          <span class="text-4xl">‚öΩ</span>
          <div>
            <h1 class="text-2xl font-bold">Th√†nh Trung M10</h1>
            <p class="text-xs text-green-100">C·ªông ƒë·ªìng b√≥ng ƒë√°</p>
          </div>
        </a>
        <div class="hidden md:flex items-center gap-6">
          <a href="../index.html" class="text-white/80 hover:text-white transition font-medium">Trang ch·ªß</a>
          <a href="../san-bong.html" class="text-white/80 hover:text-white transition font-medium">S√¢n b√≥ng</a>
          <a href="shop.html" class="text-white/80 hover:text-white transition font-medium">C·ª≠a h√†ng</a>
          <a href="community.html" class="text-white font-semibold">C·ªông ƒë·ªìng</a>
          <a href="about.html" class="text-white/80 hover:text-white transition font-medium">Gi·ªõi thi·ªáu</a>
          <a href="contact.html" class="text-white/80 hover:text-white transition font-medium">Li√™n h·ªá</a>
          <div id="userMenu"></div>
        </div>
        <button onclick="toggleMobileMenu()" class="md:hidden text-white text-2xl">‚ò∞</button>
      </div>
      <div id="mobileMenu" class="hidden md:hidden mt-4 pb-4 border-t border-white/20 pt-4">
        <div class="flex flex-col gap-3">
          <a href="../index.html" class="text-white/80 hover:text-white transition">Trang ch·ªß</a>
          <a href="../san-bong.html" class="text-white/80 hover:text-white transition">S√¢n b√≥ng</a>
          <a href="shop.html" class="text-white/80 hover:text-white transition">C·ª≠a h√†ng</a>
          <a href="community.html" class="text-white font-semibold">C·ªông ƒë·ªìng</a>
          <a href="about.html" class="text-white/80 hover:text-white transition">Gi·ªõi thi·ªáu</a>
          <a href="contact.html" class="text-white/80 hover:text-white transition">Li√™n h·ªá</a>
          <div id="mobileUserMenu" class="flex flex-col gap-2 mt-2 pt-2 border-t border-white/20"></div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <div class="bg-gradient-to-r from-purple-600 to-blue-600 text-white py-12">
    <div class="container mx-auto px-4 text-center">
      <h1 class="text-4xl font-bold mb-4">üèÜ C·ªông ƒë·ªìng B√≥ng ƒë√°</h1>
      <p class="text-purple-100 text-lg mb-6">K·∫øt n·ªëi, t√¨m ƒë·ªôi, t√¨m ƒë·ªëi th·ªß v√† chia s·∫ª ƒëam m√™</p>
      <button onclick="openCreateModal()" class="bg-white text-purple-600 px-8 py-3 rounded-xl font-bold hover:bg-gray-100 transition">
        ‚úèÔ∏è ƒêƒÉng b√†i m·ªõi
      </button>
    </div>
  </div>

  <div class="container mx-auto px-4 py-8">
    <div class="flex flex-col lg:flex-row gap-8">
      <!-- Sidebar -->
      <div class="lg:w-64 flex-shrink-0">
        <div class="bg-white rounded-xl shadow-md p-4 sticky top-4">
          <h3 class="font-bold text-gray-800 mb-4">üìã Danh m·ª•c</h3>
          <div class="space-y-2">
            <button onclick="filterPosts('all')" class="filter-btn w-full text-left px-4 py-3 rounded-lg bg-purple-100 text-purple-700 font-semibold" data-type="all">
              üåê T·∫•t c·∫£
            </button>
            <button onclick="filterPosts('find_match')" class="filter-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition" data-type="find_match">
              ‚öΩ T√¨m k√®o / Gh√©p ƒë·ªôi
            </button>
            <button onclick="filterPosts('tournament')" class="filter-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition" data-type="tournament">
              üèÜ Gi·∫£i ƒë·∫•u
            </button>
            <button onclick="filterPosts('share')" class="filter-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition" data-type="share">
              üí¨ Chia s·∫ª / Th·∫£o lu·∫≠n
            </button>
          </div>
          
          <div class="mt-6 pt-6 border-t">
            <h3 class="font-bold text-gray-800 mb-3">üìä Th·ªëng k√™</h3>
            <div class="space-y-2 text-sm text-gray-600">
              <p>üìù <span id="totalPosts">0</span> b√†i ƒëƒÉng</p>
              <p>üë• <span id="totalMembers">500+</span> th√†nh vi√™n</p>
              <p>‚öΩ <span id="totalMatches">100+</span> tr·∫≠n ƒë·∫•u</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="flex-1">
        <div id="loading" class="text-center py-12">
          <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600"></div>
          <p class="mt-4 text-gray-600">ƒêang t·∫£i b√†i ƒëƒÉng...</p>
        </div>
        
        <div id="postsContainer" class="space-y-6 hidden"></div>
        
        <div id="emptyState" class="hidden text-center py-12">
          <div class="text-6xl mb-4">üì≠</div>
          <p class="text-gray-500 text-lg">Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o</p>
          <button onclick="openCreateModal()" class="mt-4 bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
            ƒêƒÉng b√†i ƒë·∫ßu ti√™n
          </button>
        </div>
        
        <!-- Pagination -->
        <div id="pagination" class="hidden flex justify-center gap-2 mt-8"></div>
      </div>
    </div>
  </div>


  <!-- Create Post Modal -->
  <div id="createModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div class="p-6 border-b bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-t-2xl">
        <div class="flex justify-between items-center">
          <h3 class="text-2xl font-bold">‚úèÔ∏è ƒêƒÉng b√†i m·ªõi</h3>
          <button onclick="closeCreateModal()" class="text-white hover:text-gray-200 text-3xl">&times;</button>
        </div>
      </div>
      <form id="postForm" class="p-6 space-y-4">
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Lo·∫°i b√†i ƒëƒÉng *</label>
          <select id="postType" required class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" onchange="toggleMatchInfo()">
            <option value="">-- Ch·ªçn lo·∫°i --</option>
            <option value="find_match">‚öΩ T√¨m k√®o / Gh√©p ƒë·ªôi / T√¨m ƒë·ªëi th·ªß</option>
            <option value="tournament">üèÜ T·∫°o gi·∫£i ƒë·∫•u / Th√¥ng b√°o gi·∫£i</option>
            <option value="share">üí¨ Chia s·∫ª, th·∫£o lu·∫≠n</option>
          </select>
        </div>
        
        <div>
          <label class="block text-gray-700 font-semibold mb-2">Ti√™u ƒë·ªÅ *</label>
          <input type="text" id="postTitle" required maxlength="200" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="VD: T√¨m ƒë·ªëi th·ªß giao l∆∞u t·ªëi th·ª© 7">
        </div>
        
        <div>
          <label class="block text-gray-700 font-semibold mb-2">N·ªôi dung *</label>
          <textarea id="postContent" required rows="4" maxlength="2000" class="w-full px-4 py-3 border rounded-lg focus:ring-2 focus:ring-purple-500" placeholder="M√¥ t·∫£ chi ti·∫øt..."></textarea>
        </div>
        
        <!-- Match Info (hi·ªán khi ch·ªçn t√¨m ƒë·ªôi/ƒë·ªëi th·ªß) -->
        <div id="matchInfoSection" class="hidden space-y-4 p-4 bg-purple-50 rounded-lg">
          <h4 class="font-bold text-purple-800">üìÖ Th√¥ng tin tr·∫≠n ƒë·∫•u</h4>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-gray-700 text-sm mb-1">Ng√†y</label>
              <input type="date" id="matchDate" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-gray-700 text-sm mb-1">Gi·ªù</label>
              <input type="time" id="matchTime" class="w-full px-3 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-gray-700 text-sm mb-1">ƒê·ªãa ƒëi·ªÉm</label>
              <input type="text" id="matchLocation" class="w-full px-3 py-2 border rounded-lg" placeholder="VD: S√¢n Th√†nh Trung M10">
            </div>
            <div>
              <label class="block text-gray-700 text-sm mb-1">Lo·∫°i s√¢n</label>
              <select id="matchFieldType" class="w-full px-3 py-2 border rounded-lg">
                <option value="5vs5">S√¢n 5 ng∆∞·ªùi</option>
                <option value="7vs7">S√¢n 7 ng∆∞·ªùi</option>
                <option value="11vs11">S√¢n 11 ng∆∞·ªùi</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 text-sm mb-1">Tr√¨nh ƒë·ªô</label>
              <select id="matchSkillLevel" class="w-full px-3 py-2 border rounded-lg">
                <option value="any">T·∫•t c·∫£ tr√¨nh ƒë·ªô</option>
                <option value="beginner">M·ªõi ch∆°i</option>
                <option value="intermediate">Trung b√¨nh</option>
                <option value="advanced">N√¢ng cao</option>
              </select>
            </div>
            <div>
              <label class="block text-gray-700 text-sm mb-1">SƒêT li√™n h·ªá</label>
              <input type="tel" id="matchPhone" class="w-full px-3 py-2 border rounded-lg" placeholder="0123 456 789">
            </div>
          </div>
        </div>
        
        <div class="flex gap-4 pt-4">
          <button type="submit" class="flex-1 bg-purple-600 text-white py-3 rounded-lg hover:bg-purple-700 transition font-semibold">
            üì§ ƒêƒÉng b√†i
          </button>
          <button type="button" onclick="closeCreateModal()" class="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg hover:bg-gray-400 transition font-semibold">
            H·ªßy
          </button>
        </div>
      </form>
    </div>
  </div>


  <!-- Post Detail Modal -->
  <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
      <div id="detailContent"></div>
    </div>
  </div>

  <!-- Report Modal -->
  <div id="reportModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
      <div class="p-6 border-b bg-red-600 text-white rounded-t-2xl">
        <div class="flex justify-between items-center">
          <h3 class="text-xl font-bold">üö® B√°o c√°o b√†i ƒëƒÉng</h3>
          <button onclick="closeReportModal()" class="text-white hover:text-gray-200 text-2xl">&times;</button>
        </div>
      </div>
      <div class="p-6">
        <p class="text-gray-600 mb-4">Vui l√≤ng ch·ªçn l√Ω do b√°o c√°o:</p>
        <div class="space-y-3 mb-4">
          <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
            <input type="radio" name="reportReason" value="spam" class="w-4 h-4 text-red-600">
            <div>
              <p class="font-semibold">üö´ Spam / Qu·∫£ng c√°o</p>
              <p class="text-sm text-gray-500">N·ªôi dung qu·∫£ng c√°o, spam kh√¥ng li√™n quan</p>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
            <input type="radio" name="reportReason" value="inappropriate" class="w-4 h-4 text-red-600">
            <div>
              <p class="font-semibold">üîû N·ªôi dung kh√¥ng ph√π h·ª£p</p>
              <p class="text-sm text-gray-500">Ng√¥n t·ª´ t·ª•c tƒ©u, b·∫°o l·ª±c, khi√™u d√¢m</p>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
            <input type="radio" name="reportReason" value="fake" class="w-4 h-4 text-red-600">
            <div>
              <p class="font-semibold">‚ùå Th√¥ng tin gi·∫£ m·∫°o</p>
              <p class="text-sm text-gray-500">Th√¥ng tin sai s·ª± th·∫≠t, l·ª´a ƒë·∫£o</p>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
            <input type="radio" name="reportReason" value="harassment" class="w-4 h-4 text-red-600">
            <div>
              <p class="font-semibold">üò† Qu·∫•y r·ªëi / X√∫c ph·∫°m</p>
              <p class="text-sm text-gray-500">C√¥ng k√≠ch c√° nh√¢n, ph√¢n bi·ªát ƒë·ªëi x·ª≠</p>
            </div>
          </label>
          <label class="flex items-center gap-3 p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
            <input type="radio" name="reportReason" value="other" class="w-4 h-4 text-red-600">
            <div>
              <p class="font-semibold">üìù L√Ω do kh√°c</p>
              <p class="text-sm text-gray-500">M√¥ t·∫£ chi ti·∫øt b√™n d∆∞·ªõi</p>
            </div>
          </label>
        </div>
        <div class="mb-4">
          <label class="block text-gray-700 font-semibold mb-2">M√¥ t·∫£ th√™m (t√πy ch·ªçn):</label>
          <textarea id="reportDescription" rows="3" class="w-full px-4 py-2 border rounded-lg" placeholder="M√¥ t·∫£ chi ti·∫øt v·∫•n ƒë·ªÅ..."></textarea>
        </div>
        <div class="flex gap-3">
          <button onclick="closeReportModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 font-semibold">
            H·ªßy
          </button>
          <button onclick="submitReport()" class="flex-1 bg-red-600 text-white py-3 rounded-lg hover:bg-red-700 font-semibold">
            G·ª≠i b√°o c√°o
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toastContainer" class="fixed top-4 right-4 z-[100] flex flex-col gap-3"></div>

  <script src="../js/main.js"></script>
  <script>
    // API_URL ƒë√£ ƒë∆∞·ª£c khai b√°o trong main.js
    let currentType = 'all';
    let currentPage = 1;
    let allPosts = [];

    const typeInfo = {
      find_match: { icon: '‚öΩ', name: 'T√¨m k√®o', color: 'bg-green-100 text-green-800' },
      tournament: { icon: 'üèÜ', name: 'Gi·∫£i ƒë·∫•u', color: 'bg-yellow-100 text-yellow-800' },
      share: { icon: 'üí¨', name: 'Chia s·∫ª', color: 'bg-purple-100 text-purple-800' }
    };

    const skillLevelMap = {
      any: 'T·∫•t c·∫£',
      beginner: 'M·ªõi ch∆°i',
      intermediate: 'Trung b√¨nh',
      advanced: 'N√¢ng cao'
    };

    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const colors = { success: 'bg-green-500', error: 'bg-red-500', info: 'bg-blue-500' };
      toast.className = `${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    async function loadPosts() {
      try {
        const typeQuery = currentType !== 'all' ? `&type=${currentType}` : '';
        const response = await fetch(`${API_URL}/community?page=${currentPage}&limit=10${typeQuery}`);
        const data = await response.json();
        
        allPosts = data.posts;
        document.getElementById('totalPosts').textContent = data.pagination.total;
        document.getElementById('loading').classList.add('hidden');
        
        if (allPosts.length === 0) {
          document.getElementById('postsContainer').classList.add('hidden');
          document.getElementById('emptyState').classList.remove('hidden');
        } else {
          document.getElementById('emptyState').classList.add('hidden');
          displayPosts(allPosts);
        }
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('loading').innerHTML = '<p class="text-red-600">L·ªói t·∫£i d·ªØ li·ªáu</p>';
      }
    }

    function displayPosts(posts) {
      const container = document.getElementById('postsContainer');
      container.classList.remove('hidden');
      const isLoggedIn = checkAuth();
      const currentUserId = getUser()?._id;
      
      console.log('Display posts:', { isLoggedIn, currentUserId, postsCount: posts.length });
      
      container.innerHTML = posts.map(post => {
        const type = typeInfo[post.type] || { icon: 'üìù', name: 'B√†i ƒëƒÉng', color: 'bg-gray-100 text-gray-800' };
        const date = new Date(post.createdAt).toLocaleDateString('vi-VN');
        const hasMatchInfo = post.matchInfo && post.matchInfo.date;
        const isAuthor = currentUserId === post.author?._id;
        const showReportBtn = isLoggedIn && !isAuthor;
        
        return `
          <div class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition">
            <div class="p-6 cursor-pointer" onclick="openDetailModal('${post._id}')">
              <div class="flex items-start justify-between mb-4">
                <div class="flex items-center gap-3">
                  <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-xl">
                    ${post.author?.name?.charAt(0).toUpperCase() || '?'}
                  </div>
                  <div>
                    <p class="font-semibold text-gray-800">${post.author?.name || '·∫®n danh'}</p>
                    <p class="text-sm text-gray-500">${date}</p>
                  </div>
                </div>
                <span class="px-3 py-1 rounded-full text-sm font-semibold ${type.color}">
                  ${type.icon} ${type.name}
                </span>
              </div>
              
              <h3 class="text-xl font-bold text-gray-800 mb-2">${post.title}</h3>
              <p class="text-gray-600 mb-4 line-clamp-2">${post.content}</p>
              
              ${hasMatchInfo ? `
                <div class="bg-gray-50 rounded-lg p-3 mb-4">
                  <div class="flex flex-wrap gap-4 text-sm">
                    <span>üìÖ ${new Date(post.matchInfo.date).toLocaleDateString('vi-VN')}</span>
                    ${post.matchInfo.time ? `<span>‚è∞ ${post.matchInfo.time}</span>` : ''}
                    ${post.matchInfo.location ? `<span>üìç ${post.matchInfo.location}</span>` : ''}
                    ${post.matchInfo.fieldType ? `<span>üèüÔ∏è S√¢n ${post.matchInfo.fieldType.replace('vs', ' vs ')}</span>` : ''}
                  </div>
                </div>
              ` : ''}
              
              <div class="flex items-center gap-6 text-gray-500 text-sm">
                <span>‚ù§Ô∏è ${post.likes?.length || 0} th√≠ch</span>
                <span>üí¨ ${post.comments?.length || 0} b√¨nh lu·∫≠n</span>
                <span>üëÅÔ∏è ${post.views || 0} l∆∞·ª£t xem</span>
                ${post.interested?.length ? `<span class="text-green-600 font-semibold">‚úÖ ${post.interested.length} quan t√¢m</span>` : ''}
              </div>
            </div>
            
            <!-- Action buttons -->
            <div class="px-6 pb-4 flex items-center justify-between border-t pt-3">
              <button onclick="event.stopPropagation(); openDetailModal('${post._id}')" class="text-blue-600 hover:text-blue-800 text-sm font-semibold">
                Xem chi ti·∫øt ‚Üí
              </button>
              ${showReportBtn ? `
                <button onclick="event.stopPropagation(); showReportForm('${post._id}')" class="text-red-500 hover:text-red-700 text-sm flex items-center gap-1">
                  üö® B√°o c√°o
                </button>
              ` : ''}
            </div>
            
            ${post.status === 'closed' ? `
              <div class="bg-gray-200 text-gray-600 text-center py-2 text-sm font-semibold">
                ‚úÖ ƒê√£ ƒë√≥ng
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function filterPosts(type) {
      currentType = type;
      currentPage = 1;
      
      document.querySelectorAll('.filter-btn').forEach(btn => {
        if (btn.dataset.type === type) {
          btn.className = 'filter-btn w-full text-left px-4 py-3 rounded-lg bg-purple-100 text-purple-700 font-semibold';
        } else {
          btn.className = 'filter-btn w-full text-left px-4 py-3 rounded-lg hover:bg-gray-100 transition';
        }
      });
      
      document.getElementById('loading').classList.remove('hidden');
      document.getElementById('postsContainer').classList.add('hidden');
      loadPosts();
    }

    function toggleMatchInfo() {
      const type = document.getElementById('postType').value;
      const section = document.getElementById('matchInfoSection');
      if (['find_match', 'tournament'].includes(type)) {
        section.classList.remove('hidden');
      } else {
        section.classList.add('hidden');
      }
    }

    function openCreateModal() {
      if (!checkAuth()) {
        showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒëƒÉng b√†i', 'error');
        setTimeout(() => window.location.href = 'login.html', 1500);
        return;
      }
      document.getElementById('postForm').reset();
      document.getElementById('matchInfoSection').classList.add('hidden');
      document.getElementById('createModal').classList.remove('hidden');
    }

    function closeCreateModal() {
      document.getElementById('createModal').classList.add('hidden');
    }

    document.getElementById('postForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const type = document.getElementById('postType').value;
      const data = {
        type,
        title: document.getElementById('postTitle').value,
        content: document.getElementById('postContent').value
      };
      
      if (['find_match', 'tournament'].includes(type)) {
        data.matchInfo = {
          date: document.getElementById('matchDate').value || null,
          time: document.getElementById('matchTime').value || null,
          location: document.getElementById('matchLocation').value || null,
          fieldType: document.getElementById('matchFieldType').value,
          skillLevel: document.getElementById('matchSkillLevel').value,
          contactPhone: document.getElementById('matchPhone').value || null
        };
      }
      
      try {
        const response = await fetch(`${API_URL}/community`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
          },
          body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          if (result.warning) {
            showToast('‚è≥ ' + result.warning, 'info');
          } else {
            showToast('ƒêƒÉng b√†i th√†nh c√¥ng!');
          }
          closeCreateModal();
          loadPosts();
        } else {
          showToast(result.message || 'L·ªói ƒëƒÉng b√†i', 'error');
        }
      } catch (error) {
        showToast('L·ªói k·∫øt n·ªëi server', 'error');
      }
    });

    async function openDetailModal(postId) {
      try {
        const response = await fetch(`${API_URL}/community/${postId}`);
        const post = await response.json();
        
        const type = typeInfo[post.type] || { icon: 'üìù', name: 'B√†i ƒëƒÉng', color: 'bg-gray-100 text-gray-800' };
        const isAuthor = checkAuth() && getUser()?._id === post.author?._id;
        
        document.getElementById('detailContent').innerHTML = `
          <div class="p-6 border-b">
            <div class="flex justify-between items-start">
              <span class="px-3 py-1 rounded-full text-sm font-semibold ${type.color}">
                ${type.icon} ${type.name}
              </span>
              <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mt-4">${post.title}</h2>
            <div class="flex items-center gap-3 mt-4">
              <div class="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                ${post.author?.name?.charAt(0).toUpperCase() || '?'}
              </div>
              <div>
                <p class="font-semibold">${post.author?.name || '·∫®n danh'}</p>
                <p class="text-sm text-gray-500">${new Date(post.createdAt).toLocaleString('vi-VN')}</p>
              </div>
            </div>
          </div>
          
          <div class="p-6">
            <p class="text-gray-700 whitespace-pre-wrap mb-6">${post.content}</p>
            
            ${post.matchInfo?.date ? `
              <div class="bg-purple-50 rounded-xl p-4 mb-6">
                <h4 class="font-bold text-purple-800 mb-3">üìÖ Th√¥ng tin tr·∫≠n ƒë·∫•u</h4>
                <div class="grid grid-cols-2 gap-3 text-sm">
                  <p><span class="text-gray-500">Ng√†y:</span> <strong>${new Date(post.matchInfo.date).toLocaleDateString('vi-VN')}</strong></p>
                  ${post.matchInfo.time ? `<p><span class="text-gray-500">Gi·ªù:</span> <strong>${post.matchInfo.time}</strong></p>` : ''}
                  ${post.matchInfo.location ? `<p><span class="text-gray-500">ƒê·ªãa ƒëi·ªÉm:</span> <strong>${post.matchInfo.location}</strong></p>` : ''}
                  ${post.matchInfo.fieldType ? `<p><span class="text-gray-500">Lo·∫°i s√¢n:</span> <strong>S√¢n ${post.matchInfo.fieldType.replace('vs', ' vs ')}</strong></p>` : ''}
                  ${post.matchInfo.skillLevel ? `<p><span class="text-gray-500">Tr√¨nh ƒë·ªô:</span> <strong>${skillLevelMap[post.matchInfo.skillLevel]}</strong></p>` : ''}
                  ${post.matchInfo.contactPhone ? `<p><span class="text-gray-500">Li√™n h·ªá:</span> <strong><a href="tel:${post.matchInfo.contactPhone}" class="text-blue-600">${post.matchInfo.contactPhone}</a></strong></p>` : ''}
                </div>
              </div>
            ` : ''}
            
            <div class="flex items-center gap-4 mb-6">
              <button onclick="toggleLike('${post._id}')" class="flex items-center gap-2 px-4 py-2 rounded-lg hover:bg-gray-100 transition">
                ‚ù§Ô∏è <span id="likeCount">${post.likes?.length || 0}</span> th√≠ch
              </button>
              <span class="text-gray-500">üëÅÔ∏è ${post.views} l∆∞·ª£t xem</span>
              ${post.interested?.length ? `<span class="text-green-600 font-semibold">‚úÖ ${post.interested.length} quan t√¢m</span>` : ''}
            </div>
            
            ${post.status === 'active' && !isAuthor && ['find_match', 'tournament'].includes(post.type) ? `
              <button onclick="showInterestForm('${post._id}')" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition font-semibold mb-4">
                ‚úã T√¥i quan t√¢m / ƒêƒÉng k√Ω tham gia
              </button>
            ` : ''}
            
            ${!isAuthor && checkAuth() ? `
              <button onclick="showReportForm('${post._id}')" class="w-full bg-gray-100 text-gray-600 py-2 rounded-lg hover:bg-gray-200 transition text-sm mb-6">
                üö® B√°o c√°o b√†i ƒëƒÉng kh√¥ng ph√π h·ª£p
              </button>
            ` : ''}
            
            <!-- Comments -->
            <div class="border-t pt-6">
              <h4 class="font-bold text-gray-800 mb-4">üí¨ B√¨nh lu·∫≠n (${post.comments?.length || 0})</h4>
              <div id="commentsList" class="space-y-4 mb-4">
                ${post.comments?.map(c => `
                  <div class="flex gap-3">
                    <div class="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-sm">
                      ${c.user?.name?.charAt(0).toUpperCase() || '?'}
                    </div>
                    <div class="flex-1 bg-gray-100 rounded-lg p-3">
                      <p class="font-semibold text-sm">${c.user?.name || '·∫®n danh'}</p>
                      <p class="text-gray-700">${c.content}</p>
                    </div>
                  </div>
                `).join('') || '<p class="text-gray-500">Ch∆∞a c√≥ b√¨nh lu·∫≠n</p>'}
              </div>
              ${checkAuth() ? `
                <div class="flex gap-2">
                  <input type="text" id="commentInput" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." class="flex-1 px-4 py-2 border rounded-lg">
                  <button onclick="addComment('${post._id}')" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700">G·ª≠i</button>
                </div>
              ` : '<p class="text-gray-500 text-sm">ƒêƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n</p>'}
            </div>
          </div>
        `;
        
        document.getElementById('detailModal').classList.remove('hidden');
      } catch (error) {
        showToast('L·ªói t·∫£i b√†i ƒëƒÉng', 'error');
      }
    }

    function closeDetailModal() {
      document.getElementById('detailModal').classList.add('hidden');
    }

    async function toggleLike(postId) {
      if (!checkAuth()) {
        showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p', 'error');
        return;
      }
      try {
        const response = await fetch(`${API_URL}/community/${postId}/like`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        const data = await response.json();
        document.getElementById('likeCount').textContent = data.likes;
      } catch (error) {
        showToast('L·ªói', 'error');
      }
    }

    async function addComment(postId) {
      const input = document.getElementById('commentInput');
      if (!input.value.trim()) return;
      
      try {
        await fetch(`${API_URL}/community/${postId}/comment`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
          },
          body: JSON.stringify({ content: input.value })
        });
        showToast('ƒê√£ th√™m b√¨nh lu·∫≠n');
        openDetailModal(postId);
      } catch (error) {
        showToast('L·ªói', 'error');
      }
    }

    function showInterestForm(postId) {
      if (!checkAuth()) {
        showToast('Vui l√≤ng ƒëƒÉng nh·∫≠p', 'error');
        return;
      }
      const message = prompt('Nh·∫≠p l·ªùi nh·∫Øn (t√πy ch·ªçn):');
      const phone = prompt('S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá:');
      if (phone) {
        registerInterest(postId, message, phone);
      }
    }

    async function registerInterest(postId, message, phone) {
      try {
        const response = await fetch(`${API_URL}/community/${postId}/interest`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
          },
          body: JSON.stringify({ message, phone })
        });
        
        if (response.ok) {
          showToast('ƒê√£ ƒëƒÉng k√Ω th√†nh c√¥ng! Ch·ªß b√†i ƒëƒÉng s·∫Ω li√™n h·ªá b·∫°n.');
          closeDetailModal();
        } else {
          const error = await response.json();
          showToast(error.message, 'error');
        }
      } catch (error) {
        showToast('L·ªói', 'error');
      }
    }

    let currentReportPostId = null;

    function showReportForm(postId) {
      currentReportPostId = postId;
      document.querySelectorAll('input[name="reportReason"]').forEach(r => r.checked = false);
      document.getElementById('reportDescription').value = '';
      document.getElementById('reportModal').classList.remove('hidden');
    }

    function closeReportModal() {
      document.getElementById('reportModal').classList.add('hidden');
      currentReportPostId = null;
    }

    async function submitReport() {
      const reasonInput = document.querySelector('input[name="reportReason"]:checked');
      if (!reasonInput) {
        showToast('Vui l√≤ng ch·ªçn l√Ω do b√°o c√°o', 'error');
        return;
      }
      
      const reason = reasonInput.value;
      const description = document.getElementById('reportDescription').value.trim();
      
      if (reason === 'other' && !description) {
        showToast('Vui l√≤ng m√¥ t·∫£ chi ti·∫øt l√Ω do', 'error');
        return;
      }
      
      await reportPost(currentReportPostId, reason, description);
    }

    async function reportPost(postId, reason, description) {
      try {
        const response = await fetch(`${API_URL}/community/${postId}/report`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${getToken()}`
          },
          body: JSON.stringify({ reason, description })
        });
        
        if (response.ok) {
          showToast('C·∫£m ∆°n b·∫°n ƒë√£ b√°o c√°o! Ch√∫ng t√¥i s·∫Ω xem x√©t.', 'success');
          closeReportModal();
          closeDetailModal();
        } else {
          const error = await response.json();
          showToast(error.message, 'error');
        }
      } catch (error) {
        showToast('L·ªói g·ª≠i b√°o c√°o', 'error');
      }
    }

    // Init - Check URL params for filter
    const urlParams = new URLSearchParams(window.location.search);
    const typeParam = urlParams.get('type');
    if (typeParam && ['find_match', 'tournament', 'share'].includes(typeParam)) {
      filterPosts(typeParam);
    } else {
      loadPosts();
    }
  </script>
  <!-- Footer -->`n  <div id="footer"></div>`n</body>
</html>
