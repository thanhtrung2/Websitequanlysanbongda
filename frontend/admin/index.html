<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - ThÃ nh Trung M10</title>
  <link rel="stylesheet" href="../css/tailwind-fallback.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sidebar-link { transition: all 0.2s; }
    .sidebar-link:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); }
    .sidebar-link.active { background: rgba(255,255,255,0.15); border-left: 3px solid #fbbf24; }
    .stat-card { transition: all 0.3s; }
    .stat-card:hover { transform: translateY(-4px); }
    .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
  </style>
</head>
<body class="bg-gray-100">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-gradient-to-b from-slate-800 to-slate-900 text-white flex flex-col">
      <div class="p-5 border-b border-white/10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-green-400 to-emerald-600 rounded-xl flex items-center justify-center text-xl">âš½</div>
          <div>
            <h1 class="font-bold text-lg">ThÃ nh Trung M10</h1>
            <p class="text-xs text-slate-400">Admin Panel</p>
          </div>
        </div>
      </div>
      <nav class="flex-1 py-4 px-3 space-y-1 overflow-y-auto">
        <a href="index.html" class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium">
          <span>ğŸ“Š</span> Dashboard
        </a>
        <a href="fields.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300">
          <span>âš½</span> Quáº£n lÃ½ sÃ¢n
        </a>
        <a href="bookings.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300">
          <span>ğŸ“…</span> Lá»‹ch Ä‘áº·t sÃ¢n
        </a>
        <a href="customers.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300">
          <span>ğŸ‘¥</span> KhÃ¡ch hÃ ng
        </a>
        <a href="community.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300">
          <span>ğŸ†</span> Cá»™ng Ä‘á»“ng
        </a>
        <div class="pt-2 mt-2 border-t border-white/10">
          <p class="px-4 py-2 text-xs text-slate-500 uppercase">Quáº£n lÃ½</p>
        </div>
        <a href="revenue.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300">
          <span>ğŸ’°</span> TÃ i chÃ­nh
        </a>
        <a href="inventory.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300">
          <span>ğŸ“¦</span> Kho hÃ ng
        </a>
        <a href="promotions.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300">
          <span>ğŸ</span> Khuyáº¿n mÃ£i
        </a>
        <a href="staff.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300">
          <span>ğŸ‘”</span> NhÃ¢n viÃªn
        </a>
        <a href="reports.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300">
          <span>ğŸ“ˆ</span> BÃ¡o cÃ¡o
        </a>
      </nav>
      <div class="p-3 border-t border-white/10">
        <a href="../index.html" class="sidebar-link flex items-center gap-3 px-4 py-2 rounded-xl text-sm text-slate-400">
          <span>ğŸ </span> Vá» trang chá»§
        </a>
        <button onclick="logout()" class="w-full sidebar-link flex items-center gap-3 px-4 py-2 rounded-xl text-sm text-red-400 hover:bg-red-500/20">
          <span>ğŸšª</span> ÄÄƒng xuáº¥t
        </button>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gradient-to-br from-slate-50 to-slate-100">
      <!-- Header -->
      <header class="glass sticky top-0 z-10 border-b border-slate-200">
        <div class="flex justify-between items-center px-6 py-4">
          <div>
            <h2 class="text-xl font-bold text-slate-800">Dashboard</h2>
            <p class="text-sm text-slate-500">Tá»•ng quan há»‡ thá»‘ng</p>
          </div>
          <div class="flex items-center gap-4">
            <button class="relative p-2 text-slate-500 hover:bg-slate-100 rounded-xl">
              <span class="text-xl">ğŸ””</span>
              <span class="absolute top-1 right-1 w-2 h-2 bg-red-500 rounded-full"></span>
            </button>
            <div class="flex items-center gap-3 pl-4 border-l border-slate-200">
              <div class="text-right">
                <p id="adminName" class="font-semibold text-slate-800">Admin</p>
                <p class="text-xs text-slate-500">Quáº£n trá»‹ viÃªn</p>
              </div>
              <div class="w-10 h-10 bg-gradient-to-br from-green-400 to-emerald-600 rounded-xl flex items-center justify-center text-white font-bold">A</div>
            </div>
          </div>
        </div>
      </header>

      <!-- Dashboard Content -->
      <div class="p-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="stat-card bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-slate-500">Tá»•ng sÃ¢n</p>
                <p class="text-2xl font-bold text-slate-800 mt-1" id="totalFields">0</p>
              </div>
              <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl">âš½</div>
            </div>
            <div class="mt-3 flex items-center text-xs text-green-600">
              <span>â†‘ 2 sÃ¢n má»›i</span>
            </div>
          </div>
          <div class="stat-card bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-slate-500">Äáº·t sÃ¢n hÃ´m nay</p>
                <p class="text-2xl font-bold text-slate-800 mt-1" id="todayBookings">0</p>
              </div>
              <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">ğŸ“…</div>
            </div>
            <div class="mt-3 flex items-center text-xs text-blue-600">
              <span>Äang hoáº¡t Ä‘á»™ng</span>
            </div>
          </div>
          <div class="stat-card bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-slate-500">Doanh thu thÃ¡ng</p>
                <p class="text-2xl font-bold text-slate-800 mt-1" id="monthRevenue">0Ä‘</p>
              </div>
              <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center text-2xl">ğŸ’°</div>
            </div>
            <div class="mt-3 flex items-center text-xs text-yellow-600">
              <span>â†‘ 12% so vá»›i thÃ¡ng trÆ°á»›c</span>
            </div>
          </div>
          <div class="stat-card bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-slate-500">KhÃ¡ch hÃ ng</p>
                <p class="text-2xl font-bold text-slate-800 mt-1" id="totalCustomers">0</p>
              </div>
              <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-2xl">ğŸ‘¥</div>
            </div>
            <div class="mt-3 flex items-center text-xs text-purple-600">
              <span>â†‘ 5 khÃ¡ch má»›i</span>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="grid lg:grid-cols-3 gap-4 mb-6">
          <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div class="flex justify-between items-center mb-4">
              <h3 class="font-bold text-slate-800">Doanh thu 7 ngÃ y qua</h3>
              <select class="text-sm border rounded-lg px-3 py-1 text-slate-600">
                <option>7 ngÃ y</option>
                <option>30 ngÃ y</option>
              </select>
            </div>
            <canvas id="revenueChart" height="120"></canvas>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <h3 class="font-bold text-slate-800 mb-4">Loáº¡i sÃ¢n phá»• biáº¿n</h3>
            <canvas id="fieldTypeChart" height="180"></canvas>
          </div>
        </div>

        <!-- Recent Bookings & Quick Actions -->
        <div class="grid lg:grid-cols-3 gap-4">
          <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-100">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
              <h3 class="font-bold text-slate-800">Äáº·t sÃ¢n gáº§n Ä‘Ã¢y</h3>
              <a href="bookings.html" class="text-sm text-green-600 hover:underline">Xem táº¥t cáº£ â†’</a>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50">
                  <tr>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase">KhÃ¡ch hÃ ng</th>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase">SÃ¢n</th>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Thá»i gian</th>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Tráº¡ng thÃ¡i</th>
                  </tr>
                </thead>
                <tbody id="recentBookings" class="divide-y divide-slate-100">
                  <tr><td colspan="4" class="px-5 py-8 text-center text-slate-400">Äang táº£i...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="space-y-4">
            <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-5 text-white">
              <h3 class="font-bold mb-3">Thao tÃ¡c nhanh</h3>
              <div class="space-y-2">
                <a href="fields.html" class="flex items-center gap-3 bg-white/20 hover:bg-white/30 rounded-xl px-4 py-3 transition">
                  <span>â•</span> ThÃªm sÃ¢n má»›i
                </a>
                <a href="bookings.html" class="flex items-center gap-3 bg-white/20 hover:bg-white/30 rounded-xl px-4 py-3 transition">
                  <span>ğŸ“‹</span> Xem Ä‘Æ¡n chá» duyá»‡t
                </a>
                <a href="promotions.html" class="flex items-center gap-3 bg-white/20 hover:bg-white/30 rounded-xl px-4 py-3 transition">
                  <span>ğŸ</span> Táº¡o khuyáº¿n mÃ£i
                </a>
              </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
              <h3 class="font-bold text-slate-800 mb-3">Cáº§n xá»­ lÃ½</h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-xl">
                  <div class="flex items-center gap-2">
                    <span class="text-yellow-500">â³</span>
                    <span class="text-sm text-slate-700">ÄÆ¡n chá» xÃ¡c nháº­n</span>
                  </div>
                  <span id="pendingCount" class="bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                </div>
                <div class="flex items-center justify-between p-3 bg-red-50 rounded-xl">
                  <div class="flex items-center gap-2">
                    <span class="text-red-500">ğŸ“¦</span>
                    <span class="text-sm text-slate-700">Sáº£n pháº©m sáº¯p háº¿t</span>
                  </div>
                  <span class="bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-full">3</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    
    if (!token) { window.location.href = 'login.html'; }
    else if (user.role !== 'admin') { alert('Báº¡n khÃ´ng cÃ³ quyá»n admin!'); window.location.href = 'login.html'; }
    
    document.getElementById('adminName').textContent = user.name || 'Admin';
    function logout() { localStorage.clear(); window.location.href = '../index.html'; }

    async function loadDashboard() {
      try {
        const fieldsRes = await fetch(`${API_URL}/fields`);
        const fields = await fieldsRes.json();
        document.getElementById('totalFields').textContent = fields.length;

        const bookingsRes = await fetch(`${API_URL}/bookings`, { headers: { 'Authorization': `Bearer ${token}` } });
        const bookings = await bookingsRes.json();
        
        const today = new Date().toDateString();
        const todayBookings = bookings.filter(b => new Date(b.date).toDateString() === today);
        document.getElementById('todayBookings').textContent = todayBookings.length;

        const thisMonth = new Date().getMonth();
        const monthBookings = bookings.filter(b => new Date(b.date).getMonth() === thisMonth);
        const monthRevenue = monthBookings.reduce((sum, b) => sum + b.totalPrice, 0);
        document.getElementById('monthRevenue').textContent = (monthRevenue/1000000).toFixed(1) + 'M';

        const pendingCount = bookings.filter(b => b.status === 'pending').length;
        document.getElementById('pendingCount').textContent = pendingCount;

        try {
          const usersRes = await fetch(`${API_URL}/users`, { headers: { 'Authorization': `Bearer ${token}` } });
          if (usersRes.ok) {
            const users = await usersRes.json();
            document.getElementById('totalCustomers').textContent = users.filter(u => u.role === 'customer').length;
          }
        } catch (e) {
          document.getElementById('totalCustomers').textContent = new Set(bookings.map(b => b.user?._id).filter(Boolean)).size;
        }

        displayRecentBookings(bookings.slice(0, 5));
        drawRevenueChart(bookings);
        drawFieldTypeChart(bookings);
      } catch (error) { console.error('Error:', error); }
    }

    function displayRecentBookings(bookings) {
      const tbody = document.getElementById('recentBookings');
      if (bookings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-5 py-8 text-center text-slate-400">ChÆ°a cÃ³ Ä‘áº·t sÃ¢n</td></tr>';
        return;
      }
      const statusConfig = {
        'pending': { text: 'Chá» duyá»‡t', class: 'bg-yellow-100 text-yellow-700' },
        'confirmed': { text: 'ÄÃ£ duyá»‡t', class: 'bg-green-100 text-green-700' },
        'cancelled': { text: 'ÄÃ£ há»§y', class: 'bg-red-100 text-red-700' },
        'completed': { text: 'HoÃ n thÃ nh', class: 'bg-blue-100 text-blue-700' }
      };
      tbody.innerHTML = bookings.map(b => {
        const config = statusConfig[b.status] || statusConfig['pending'];
        return `
          <tr class="hover:bg-slate-50">
            <td class="px-5 py-3">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-sm font-bold">${(b.user?.name || 'N')[0]}</div>
                <span class="font-medium text-slate-800">${b.user?.name || 'N/A'}</span>
              </div>
            </td>
            <td class="px-5 py-3 text-slate-600">${b.field?.name || 'N/A'}</td>
            <td class="px-5 py-3 text-slate-600 text-sm">${new Date(b.date).toLocaleDateString('vi-VN')} â€¢ ${b.startTime}</td>
            <td class="px-5 py-3"><span class="px-2 py-1 rounded-lg text-xs font-semibold ${config.class}">${config.text}</span></td>
          </tr>`;
      }).join('');
    }

    function drawRevenueChart(bookings) {
      const ctx = document.getElementById('revenueChart').getContext('2d');
      const last7Days = [], revenue = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date(); date.setDate(date.getDate() - i);
        last7Days.push(date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
        revenue.push(bookings.filter(b => new Date(b.date).toDateString() === date.toDateString()).reduce((sum, b) => sum + b.totalPrice, 0) / 1000);
      }
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: last7Days,
          datasets: [{ label: 'Doanh thu (k)', data: revenue, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', tension: 0.4, fill: true }]
        },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    function drawFieldTypeChart(bookings) {
      const ctx = document.getElementById('fieldTypeChart').getContext('2d');
      const types = { '5vs5': 0, '7vs7': 0, '11vs11': 0 };
      bookings.forEach(b => { if (b.field?.type) types[b.field.type]++; });
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['SÃ¢n 5', 'SÃ¢n 7', 'SÃ¢n 11'],
          datasets: [{ data: [types['5vs5'], types['7vs7'], types['11vs11']], backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b'], borderWidth: 0 }]
        },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } }, cutout: '60%' }
      });
    }

    loadDashboard();
  </script>
</body>
</html>
