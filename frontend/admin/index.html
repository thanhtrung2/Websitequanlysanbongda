<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - Th√†nh Trung M10</title>
  <link rel="stylesheet" href="../css/tailwind-fallback.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sidebar-link { transition: all 0.2s; }
    .sidebar-link:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); }
    .sidebar-link.active { background: rgba(255,255,255,0.15); border-left: 3px solid #fbbf24; }
    .stat-card { transition: all 0.3s; }
    .stat-card:hover { transform: translateY(-4px); }
    .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
  </style>
</head>
<body class="bg-gray-100">
  <div class="flex h-screen">
    <!-- Sidebar - Dynamic -->
    <div id="admin-sidebar"></div>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto bg-gradient-to-br from-slate-50 to-slate-100">
      <!-- Header - Dynamic -->
      <div id="admin-header"></div>

      <!-- Dashboard Content -->
      <div class="p-6">
        <!-- Stats Cards -->
        <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="stat-card bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-slate-500">T·ªïng s√¢n</p>
                <p class="text-2xl font-bold text-slate-800 mt-1" id="totalFields">0</p>
              </div>
              <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center text-2xl">‚öΩ</div>
            </div>
          </div>
          <div class="stat-card bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-slate-500">ƒê·∫∑t s√¢n h√¥m nay</p>
                <p class="text-2xl font-bold text-slate-800 mt-1" id="todayBookings">0</p>
              </div>
              <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center text-2xl">üìÖ</div>
            </div>
          </div>
          <div class="stat-card bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-slate-500">Doanh thu th√°ng</p>
                <p class="text-2xl font-bold text-slate-800 mt-1" id="monthRevenue">0ƒë</p>
              </div>
              <div class="w-12 h-12 bg-yellow-100 rounded-xl flex items-center justify-center text-2xl">üí∞</div>
            </div>
          </div>
          <div class="stat-card bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <div class="flex items-center justify-between">
              <div>
                <p class="text-sm text-slate-500">Kh√°ch h√†ng</p>
                <p class="text-2xl font-bold text-slate-800 mt-1" id="totalCustomers">0</p>
              </div>
              <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center text-2xl">üë•</div>
            </div>
          </div>
        </div>

        <!-- Charts Row -->
        <div class="grid lg:grid-cols-3 gap-4 mb-6">
          <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <h3 class="font-bold text-slate-800 mb-4">Doanh thu 7 ng√†y qua</h3>
            <canvas id="revenueChart" height="120"></canvas>
          </div>
          <div class="bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
            <h3 class="font-bold text-slate-800 mb-4">Lo·∫°i s√¢n ph·ªï bi·∫øn</h3>
            <canvas id="fieldTypeChart" height="180"></canvas>
          </div>
        </div>

        <!-- Recent Bookings & Quick Actions -->
        <div class="grid lg:grid-cols-3 gap-4">
          <div class="lg:col-span-2 bg-white rounded-2xl shadow-sm border border-slate-100">
            <div class="p-5 border-b border-slate-100 flex justify-between items-center">
              <h3 class="font-bold text-slate-800">ƒê·∫∑t s√¢n g·∫ßn ƒë√¢y</h3>
              <a href="bookings.html" class="text-sm text-green-600 hover:underline">Xem t·∫•t c·∫£ ‚Üí</a>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-slate-50">
                  <tr>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Kh√°ch h√†ng</th>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase">S√¢n</th>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Th·ªùi gian</th>
                    <th class="px-5 py-3 text-left text-xs font-semibold text-slate-500 uppercase">Tr·∫°ng th√°i</th>
                  </tr>
                </thead>
                <tbody id="recentBookings" class="divide-y divide-slate-100">
                  <tr><td colspan="4" class="px-5 py-8 text-center text-slate-400">ƒêang t·∫£i...</td></tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="space-y-4">
            <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-5 text-white">
              <h3 class="font-bold mb-3">Thao t√°c nhanh</h3>
              <div class="space-y-2" id="quickActions">
                <a href="bookings.html" class="flex items-center gap-3 bg-white/20 hover:bg-white/30 rounded-xl px-4 py-3 transition">
                  <span>üìã</span> Xem ƒë∆°n ch·ªù duy·ªát
                </a>
              </div>
            </div>
            <div class="bg-white rounded-2xl shadow-sm p-5 border border-slate-100">
              <h3 class="font-bold text-slate-800 mb-3">C·∫ßn x·ª≠ l√Ω</h3>
              <div class="space-y-3">
                <div class="flex items-center justify-between p-3 bg-yellow-50 rounded-xl">
                  <div class="flex items-center gap-2">
                    <span class="text-yellow-500">‚è≥</span>
                    <span class="text-sm text-slate-700">ƒê∆°n ch·ªù x√°c nh·∫≠n</span>
                  </div>
                  <span id="pendingCount" class="bg-yellow-500 text-white text-xs font-bold px-2 py-1 rounded-full">0</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script src="components/sidebar.js"></script>
  <script>
    const API_URL = 'http://localhost:3000/api';
    const token = localStorage.getItem('token');
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    
    // Ki·ªÉm tra quy·ªÅn truy c·∫≠p
    if (!token || (user.role !== 'admin' && user.role !== 'staff')) {
      alert('Vui l√≤ng ƒëƒÉng nh·∫≠p!');
      window.location.href = 'login.html';
    }
    
    // Render sidebar v√† header
    renderAdminSidebar('dashboard');
    renderAdminHeader('Dashboard', 'T·ªïng quan h·ªá th·ªëng');
    
    // C·∫≠p nh·∫≠t quick actions theo role
    if (user.role === 'admin') {
      document.getElementById('quickActions').innerHTML = `
        <a href="fields.html" class="flex items-center gap-3 bg-white/20 hover:bg-white/30 rounded-xl px-4 py-3 transition">
          <span>‚ûï</span> Th√™m s√¢n m·ªõi
        </a>
        <a href="bookings.html" class="flex items-center gap-3 bg-white/20 hover:bg-white/30 rounded-xl px-4 py-3 transition">
          <span>üìã</span> Xem ƒë∆°n ch·ªù duy·ªát
        </a>
        <a href="promotions.html" class="flex items-center gap-3 bg-white/20 hover:bg-white/30 rounded-xl px-4 py-3 transition">
          <span>üéÅ</span> T·∫°o khuy·∫øn m√£i
        </a>
      `;
    }

    async function loadDashboard() {
      try {
        const fieldsRes = await fetch(`${API_URL}/fields`);
        const fields = await fieldsRes.json();
        document.getElementById('totalFields').textContent = fields.length;

        const bookingsRes = await fetch(`${API_URL}/bookings`, { headers: { 'Authorization': `Bearer ${token}` } });
        const bookings = await bookingsRes.json();
        
        const today = new Date().toDateString();
        const todayBookings = bookings.filter(b => new Date(b.date).toDateString() === today);
        document.getElementById('todayBookings').textContent = todayBookings.length;

        const thisMonth = new Date().getMonth();
        const monthBookings = bookings.filter(b => new Date(b.date).getMonth() === thisMonth);
        const monthRevenue = monthBookings.reduce((sum, b) => sum + (b.totalPrice || 0), 0);
        document.getElementById('monthRevenue').textContent = (monthRevenue/1000000).toFixed(1) + 'M';

        const pendingCount = bookings.filter(b => b.status === 'pending').length;
        document.getElementById('pendingCount').textContent = pendingCount;

        try {
          const usersRes = await fetch(`${API_URL}/users`, { headers: { 'Authorization': `Bearer ${token}` } });
          if (usersRes.ok) {
            const users = await usersRes.json();
            document.getElementById('totalCustomers').textContent = users.filter(u => u.role === 'customer').length;
          }
        } catch (e) {
          document.getElementById('totalCustomers').textContent = new Set(bookings.map(b => b.user?._id).filter(Boolean)).size;
        }

        displayRecentBookings(bookings.slice(0, 5));
        drawRevenueChart(bookings);
        drawFieldTypeChart(bookings);
      } catch (error) { console.error('Error:', error); }
    }

    function displayRecentBookings(bookings) {
      const tbody = document.getElementById('recentBookings');
      if (bookings.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" class="px-5 py-8 text-center text-slate-400">Ch∆∞a c√≥ ƒë·∫∑t s√¢n</td></tr>';
        return;
      }
      const statusConfig = {
        'pending': { text: 'Ch·ªù duy·ªát', class: 'bg-yellow-100 text-yellow-700' },
        'confirmed': { text: 'ƒê√£ duy·ªát', class: 'bg-green-100 text-green-700' },
        'cancelled': { text: 'ƒê√£ h·ªßy', class: 'bg-red-100 text-red-700' },
        'completed': { text: 'Ho√†n th√†nh', class: 'bg-blue-100 text-blue-700' }
      };
      tbody.innerHTML = bookings.map(b => {
        const config = statusConfig[b.status] || statusConfig['pending'];
        return `
          <tr class="hover:bg-slate-50">
            <td class="px-5 py-3">
              <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center text-sm font-bold">${(b.user?.name || 'N')[0]}</div>
                <span class="font-medium text-slate-800">${b.user?.name || 'N/A'}</span>
              </div>
            </td>
            <td class="px-5 py-3 text-slate-600">${b.field?.name || 'N/A'}</td>
            <td class="px-5 py-3 text-slate-600 text-sm">${new Date(b.date).toLocaleDateString('vi-VN')} ‚Ä¢ ${b.startTime || ''}</td>
            <td class="px-5 py-3"><span class="px-2 py-1 rounded-lg text-xs font-semibold ${config.class}">${config.text}</span></td>
          </tr>`;
      }).join('');
    }

    function drawRevenueChart(bookings) {
      const ctx = document.getElementById('revenueChart').getContext('2d');
      const last7Days = [], revenue = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date(); date.setDate(date.getDate() - i);
        last7Days.push(date.toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
        revenue.push(bookings.filter(b => new Date(b.date).toDateString() === date.toDateString()).reduce((sum, b) => sum + (b.totalPrice || 0), 0) / 1000);
      }
      new Chart(ctx, {
        type: 'line',
        data: { labels: last7Days, datasets: [{ label: 'Doanh thu (k)', data: revenue, borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,0.1)', tension: 0.4, fill: true }] },
        options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
      });
    }

    function drawFieldTypeChart(bookings) {
      const ctx = document.getElementById('fieldTypeChart').getContext('2d');
      const types = { '5vs5': 0, '7vs7': 0, '11vs11': 0 };
      bookings.forEach(b => { if (b.field?.type) types[b.field.type]++; });
      new Chart(ctx, {
        type: 'doughnut',
        data: { labels: ['S√¢n 5', 'S√¢n 7', 'S√¢n 11'], datasets: [{ data: [types['5vs5'], types['7vs7'], types['11vs11']], backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b'], borderWidth: 0 }] },
        options: { responsive: true, plugins: { legend: { position: 'bottom' } }, cutout: '60%' }
      });
    }

    loadDashboard();
  </script>
</body>
</html>
