<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quáº£n lÃ½ Cá»™ng Ä‘á»“ng - Admin</title>
  <link rel="stylesheet" href="../css/tailwind-fallback.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .sidebar-link { transition: all 0.2s; }
    .sidebar-link:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); }
    .sidebar-link.active { background: rgba(255,255,255,0.15); border-left: 3px solid #fbbf24; }
    .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
  </style>
</head>
<body class="bg-slate-50">
  <div class="flex h-screen">
    <aside class="w-64 bg-gradient-to-b from-slate-800 to-slate-900 text-white flex flex-col flex-shrink-0">
      <div class="p-5 border-b border-white/10">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 bg-gradient-to-br from-green-400 to-emerald-600 rounded-xl flex items-center justify-center text-xl">âš½</div>
          <div><h1 class="font-bold text-lg">ThÃ nh Trung M10</h1><p class="text-xs text-slate-400">Admin Panel</p></div>
        </div>
      </div>
      <nav class="flex-1 py-4 px-3 space-y-1 overflow-y-auto">
        <a href="index.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300"><span>ğŸ“Š</span> Dashboard</a>
        <a href="fields.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300"><span>âš½</span> Quáº£n lÃ½ sÃ¢n</a>
        <a href="bookings.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300"><span>ğŸ“…</span> Lá»‹ch Ä‘áº·t sÃ¢n</a>
        <a href="customers.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300"><span>ğŸ‘¥</span> KhÃ¡ch hÃ ng</a>
        <a href="community.html" class="sidebar-link active flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium"><span>ğŸ†</span> Cá»™ng Ä‘á»“ng</a>
        <div class="pt-2 mt-2 border-t border-white/10"><p class="px-4 py-2 text-xs text-slate-500 uppercase">Quáº£n lÃ½</p></div>
        <a href="revenue.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300"><span>ğŸ’°</span> TÃ i chÃ­nh</a>
        <a href="inventory.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300"><span>ğŸ“¦</span> Kho hÃ ng</a>
        <a href="promotions.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300"><span>ğŸ</span> Khuyáº¿n mÃ£i</a>
        <a href="staff.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300"><span>ğŸ‘”</span> NhÃ¢n viÃªn</a>
        <a href="reports.html" class="sidebar-link flex items-center gap-3 px-4 py-3 rounded-xl text-sm font-medium text-slate-300"><span>ğŸ“ˆ</span> BÃ¡o cÃ¡o</a>
      </nav>
      <div class="p-3 border-t border-white/10">
        <a href="../index.html" class="sidebar-link flex items-center gap-3 px-4 py-2 rounded-xl text-sm text-slate-400"><span>ğŸ </span> Vá» trang chá»§</a>
        <button onclick="logout()" class="w-full sidebar-link flex items-center gap-3 px-4 py-2 rounded-xl text-sm text-red-400 hover:bg-red-500/20"><span>ğŸšª</span> ÄÄƒng xuáº¥t</button>
      </div>
    </aside>

    <main class="flex-1 overflow-y-auto">
      <header class="glass sticky top-0 z-10 border-b border-slate-200">
        <div class="px-6 py-4"><h2 class="text-xl font-bold text-slate-800">Quáº£n lÃ½ Cá»™ng Ä‘á»“ng</h2><p class="text-sm text-slate-500">Kiá»ƒm duyá»‡t bÃ i viáº¿t vÃ  giáº£i Ä‘áº¥u</p></div>
      </header>
      <div class="p-6">
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-white rounded-2xl p-5 border border-slate-100"><p class="text-sm text-slate-500">Tá»•ng bÃ i viáº¿t</p><p id="totalPosts" class="text-2xl font-bold text-slate-800">0</p></div>
          <div class="bg-yellow-50 rounded-2xl p-5 border border-yellow-100"><p class="text-sm text-yellow-600">Chá» duyá»‡t</p><p id="pendingPosts" class="text-2xl font-bold text-yellow-700">0</p></div>
          <div class="bg-green-50 rounded-2xl p-5 border border-green-100"><p class="text-sm text-green-600">ÄÃ£ duyá»‡t</p><p id="approvedPosts" class="text-2xl font-bold text-green-700">0</p></div>
          <div class="bg-red-50 rounded-2xl p-5 border border-red-100 cursor-pointer hover:bg-red-100" onclick="filterReported()"><p class="text-sm text-red-600">Bá»‹ bÃ¡o cÃ¡o</p><p id="reportedPosts" class="text-2xl font-bold text-red-700">0</p></div>
        </div>
        <div class="flex gap-2 mb-4">
          <button onclick="loadPosts()" class="px-4 py-2 bg-slate-100 text-slate-700 rounded-xl text-sm font-medium hover:bg-slate-200">Táº¥t cáº£</button>
          <button onclick="loadPosts('pending')" class="px-4 py-2 bg-yellow-100 text-yellow-700 rounded-xl text-sm font-medium hover:bg-yellow-200">Chá» duyá»‡t</button>
          <button onclick="filterReported()" class="px-4 py-2 bg-red-100 text-red-700 rounded-xl text-sm font-medium hover:bg-red-200">CÃ³ bÃ¡o cÃ¡o</button>
        </div>
        <div id="postsContainer" class="space-y-4">
          <div class="text-center py-8 text-slate-400">Äang táº£i...</div>
        </div>
      </div>
    </main>
  </div>
  <script>
    const API_URL = 'http://localhost:3000/api';
    const token = localStorage.getItem('token');
    let allPosts = [];
    function logout() { localStorage.clear(); window.location.href = '../index.html'; }
    
    async function loadPosts(filter = '') {
      try {
        const url = filter === 'pending' 
          ? `${API_URL}/community/admin/pending`
          : `${API_URL}/community/admin/all${filter === 'reported' ? '?hasReports=true' : ''}`;
        const res = await fetch(url, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await res.json();
        const posts = data.posts || [];
        allPosts = posts;
        
        // Load stats
        const statsRes = await fetch(`${API_URL}/community/admin/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const stats = await statsRes.json();
        
        document.getElementById('totalPosts').textContent = stats.totalPosts || 0;
        document.getElementById('pendingPosts').textContent = stats.pendingPosts || 0;
        document.getElementById('approvedPosts').textContent = stats.activePosts || 0;
        document.getElementById('reportedPosts').textContent = stats.pendingReports || 0;
        
        displayPosts(posts);
      } catch (e) { 
        console.error(e);
        document.getElementById('postsContainer').innerHTML = '<p class="text-red-500 text-center">Lá»—i táº£i dá»¯ liá»‡u</p>'; 
      }
    }
    
    function filterReported() {
      loadPosts('reported');
    }
    
    function displayPosts(posts) {
      const container = document.getElementById('postsContainer');
      if (!posts.length) { container.innerHTML = '<p class="text-slate-400 text-center py-8">ChÆ°a cÃ³ bÃ i viáº¿t</p>'; return; }
      const typeMap = { 'find_team': 'ğŸ” TÃ¬m Ä‘á»“ng Ä‘á»™i', 'share': 'ğŸ“ Chia sáº»', 'tournament': 'ğŸ† Giáº£i Ä‘áº¥u' };
      const reasonMap = { 'spam': 'Spam', 'inappropriate': 'Ná»™i dung khÃ´ng phÃ¹ há»£p', 'harassment': 'Quáº¥y rá»‘i', 'fake': 'ThÃ´ng tin sai', 'other': 'KhÃ¡c' };
      
      container.innerHTML = posts.slice(0, 20).map(p => {
        const pendingReports = (p.reports || []).filter(r => r.status === 'pending');
        const hasReports = pendingReports.length > 0;
        
        return `
        <div class="bg-white rounded-2xl p-5 border ${hasReports ? 'border-red-300 bg-red-50/30' : 'border-slate-100'}">
          <div class="flex justify-between items-start mb-3">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 bg-green-100 rounded-full flex items-center justify-center font-bold text-green-700">${(p.author?.name || 'N')[0]}</div>
              <div>
                <p class="font-semibold text-slate-800">${p.author?.name || 'áº¨n danh'}</p>
                <p class="text-xs text-slate-500">${new Date(p.createdAt).toLocaleString('vi-VN')}</p>
              </div>
            </div>
            <div class="flex items-center gap-2">
              ${hasReports ? `<span class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">ğŸš¨ ${pendingReports.length} bÃ¡o cÃ¡o</span>` : ''}
              <span class="px-3 py-1 rounded-full text-xs font-semibold bg-blue-100 text-blue-700">${typeMap[p.type] || p.type}</span>
            </div>
          </div>
          <p class="text-slate-700 mb-3">${p.content?.substring(0, 200)}${p.content?.length > 200 ? '...' : ''}</p>
          
          ${hasReports ? `
          <div class="bg-red-50 rounded-xl p-3 mb-3 border border-red-200">
            <p class="text-sm font-semibold text-red-700 mb-2">ğŸ“‹ Chi tiáº¿t bÃ¡o cÃ¡o:</p>
            ${pendingReports.map(r => `
              <div class="text-sm text-red-600 mb-1">
                â€¢ <strong>${reasonMap[r.reason] || r.reason}</strong>: ${r.description || 'KhÃ´ng cÃ³ mÃ´ táº£'}
                <span class="text-xs text-red-400">(${new Date(r.createdAt).toLocaleDateString('vi-VN')})</span>
              </div>
            `).join('')}
          </div>
          ` : ''}
          
          <div class="flex gap-2 flex-wrap">
            ${p.moderationStatus === 'pending' ? `<button onclick="updatePost('${p._id}', 'approve')" class="px-4 py-2 bg-green-100 text-green-700 rounded-xl text-sm font-medium hover:bg-green-200">âœ“ Duyá»‡t</button>` : ''}
            ${hasReports ? `
              <button onclick="dismissReports('${p._id}')" class="px-4 py-2 bg-yellow-100 text-yellow-700 rounded-xl text-sm font-medium hover:bg-yellow-200">âŠ˜ Bá» qua bÃ¡o cÃ¡o</button>
              <button onclick="deleteFromReport('${p._id}')" class="px-4 py-2 bg-red-100 text-red-700 rounded-xl text-sm font-medium hover:bg-red-200">ğŸ—‘ï¸ XÃ³a (vi pháº¡m)</button>
            ` : `
              <button onclick="deletePost('${p._id}')" class="px-4 py-2 bg-red-100 text-red-700 rounded-xl text-sm font-medium hover:bg-red-200">ğŸ—‘ï¸ XÃ³a</button>
            `}
            ${p.author?._id ? `<button onclick="warnUser('${p.author._id}', '${p._id}')" class="px-4 py-2 bg-orange-100 text-orange-700 rounded-xl text-sm font-medium hover:bg-orange-200">âš ï¸ Cáº£nh bÃ¡o user</button>` : ''}
          </div>
        </div>
      `}).join('');
    }
    
    async function updatePost(id, action) {
      try {
        await fetch(`${API_URL}/community/admin/${id}/moderate`, { 
          method: 'PATCH', 
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` }, 
          body: JSON.stringify({ action }) 
        });
        loadPosts();
      } catch (e) { alert('Lá»—i'); }
    }
    
    async function deletePost(id) {
      if (!confirm('XÃ³a bÃ i viáº¿t nÃ y?')) return;
      try {
        await fetch(`${API_URL}/community/admin/${id}`, { method: 'DELETE', headers: { 'Authorization': `Bearer ${token}` } });
        loadPosts();
      } catch (e) { alert('Lá»—i'); }
    }
    
    async function dismissReports(postId) {
      if (!confirm('Bá» qua táº¥t cáº£ bÃ¡o cÃ¡o cá»§a bÃ i viáº¿t nÃ y?')) return;
      try {
        const post = allPosts.find(p => p._id === postId);
        const pendingReports = (post?.reports || []).filter(r => r.status === 'pending');
        
        for (const report of pendingReports) {
          await fetch(`${API_URL}/community/admin/${postId}/report`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ reportId: report._id, action: 'dismiss' })
          });
        }
        loadPosts();
      } catch (e) { alert('Lá»—i xá»­ lÃ½ bÃ¡o cÃ¡o'); }
    }
    
    async function deleteFromReport(postId) {
      if (!confirm('XÃ³a bÃ i viáº¿t do vi pháº¡m?')) return;
      try {
        const post = allPosts.find(p => p._id === postId);
        const pendingReport = (post?.reports || []).find(r => r.status === 'pending');
        
        if (pendingReport) {
          await fetch(`${API_URL}/community/admin/${postId}/report`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ reportId: pendingReport._id, action: 'delete_post' })
          });
        }
        loadPosts();
      } catch (e) { alert('Lá»—i'); }
    }
    
    async function warnUser(userId, postId) {
      const reason = prompt('Nháº­p lÃ½ do cáº£nh bÃ¡o:');
      if (!reason) return;
      try {
        const res = await fetch(`${API_URL}/community/admin/warn-user`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ userId, reason, postId })
        });
        const data = await res.json();
        alert(data.message + (data.isBlocked ? ' (TÃ i khoáº£n Ä‘Ã£ bá»‹ khÃ³a)' : ` (Vi pháº¡m: ${data.violationCount}/3)`));
        loadPosts();
      } catch (e) { alert('Lá»—i'); }
    }
    
    loadPosts();
  </script>
</body>
</html>
