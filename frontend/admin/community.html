<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω C·ªông ƒë·ªìng - Admin</title>
  <link rel="stylesheet" href="../css/tailwind-fallback.css">
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100">
  <div id="toastContainer" class="fixed top-4 right-4 z-[100] flex flex-col gap-3"></div>

  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-green-800 text-white flex-shrink-0">
      <div class="p-6">
        <h1 class="text-2xl font-bold">‚öΩ Admin Panel</h1>
        <p class="text-sm text-green-200">Th√†nh Trung M10</p>
      </div>
      <nav class="mt-6">
        <a href="index.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">üìä</span> Dashboard
        </a>
        <a href="fields.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">‚öΩ</span> Qu·∫£n l√Ω s√¢n
        </a>
        <a href="bookings.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">üìÖ</span> Qu·∫£n l√Ω l·ªãch ƒë·∫∑t
        </a>
        <a href="customers.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">üë•</span> Qu·∫£n l√Ω kh√°ch h√†ng
        </a>
        <a href="community.html" class="flex items-center px-6 py-3 bg-green-700 border-l-4 border-white">
          <span class="mr-3">üèÜ</span> Qu·∫£n l√Ω c·ªông ƒë·ªìng
        </a>
        <a href="revenue.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">üí∞</span> Qu·∫£n l√Ω t√†i ch√≠nh
        </a>
        <a href="inventory.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">üì¶</span> Qu·∫£n l√Ω kho
        </a>
        <a href="promotions.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">üéÅ</span> Qu·∫£n l√Ω khuy·∫øn m√£i
        </a>
        <a href="staff.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">üëî</span> Qu·∫£n l√Ω nh√¢n vi√™n
        </a>
        <a href="reports.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">üìà</span> B√°o c√°o & Th·ªëng k√™
        </a>
        <a href="../index.html" class="flex items-center px-6 py-3 hover:bg-green-700 mt-4 border-t border-green-700">
          <span class="mr-3">üè†</span> V·ªÅ trang ch·ªß
        </a>
        <a href="#" onclick="logout()" class="flex items-center px-6 py-3 hover:bg-red-700">
          <span class="mr-3">üö™</span> ƒêƒÉng xu·∫•t
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
      <header class="bg-white shadow-sm">
        <div class="flex justify-between items-center px-8 py-4">
          <h2 class="text-2xl font-bold text-gray-800">üèÜ Qu·∫£n l√Ω C·ªông ƒë·ªìng</h2>
        </div>
      </header>

      <div class="p-8">
        <!-- Stats -->
        <div class="grid grid-cols-6 gap-4 mb-6">
          <div class="bg-white rounded-xl shadow p-4">
            <p class="text-gray-500 text-xs">T·ªïng b√†i ƒëƒÉng</p>
            <p id="statTotal" class="text-2xl font-bold text-gray-800">0</p>
          </div>
          <div class="bg-white rounded-xl shadow p-4">
            <p class="text-gray-500 text-xs">ƒêang ho·∫°t ƒë·ªông</p>
            <p id="statActive" class="text-2xl font-bold text-green-600">0</p>
          </div>
          <div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg" onclick="showTab('pending')">
            <p class="text-gray-500 text-xs">Ch·ªù duy·ªát</p>
            <p id="statPending" class="text-2xl font-bold text-yellow-600">0</p>
          </div>
          <div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg" onclick="showTab('reports')">
            <p class="text-gray-500 text-xs">B√°o c√°o</p>
            <p id="statReports" class="text-2xl font-bold text-red-600">0</p>
          </div>
          <div class="bg-white rounded-xl shadow p-4">
            <p class="text-gray-500 text-xs">R·ªßi ro cao</p>
            <p id="statHighRisk" class="text-2xl font-bold text-orange-600">0</p>
          </div>
          <div class="bg-white rounded-xl shadow p-4 cursor-pointer hover:shadow-lg" onclick="showTab('blocked')">
            <p class="text-gray-500 text-xs">User b·ªã kh√≥a</p>
            <p id="statBlocked" class="text-2xl font-bold text-purple-600">0</p>
          </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-xl shadow mb-6">
          <div class="flex border-b overflow-x-auto">
            <button onclick="showTab('all')" id="tabAll" class="tab-btn flex-1 py-3 px-4 text-center font-semibold border-b-2 border-green-600 text-green-600 whitespace-nowrap">
              üìã T·∫•t c·∫£ b√†i ƒëƒÉng
            </button>
            <button onclick="showTab('pending')" id="tabPending" class="tab-btn flex-1 py-3 px-4 text-center font-semibold text-gray-500 hover:text-gray-700 whitespace-nowrap">
              ‚è≥ Ch·ªù duy·ªát (<span id="pendingCount">0</span>)
            </button>
            <button onclick="showTab('reports')" id="tabReports" class="tab-btn flex-1 py-3 px-4 text-center font-semibold text-gray-500 hover:text-gray-700 whitespace-nowrap">
              üö® B√°o c√°o (<span id="reportsCount">0</span>)
            </button>
            <button onclick="showTab('blocked')" id="tabBlocked" class="tab-btn flex-1 py-3 px-4 text-center font-semibold text-gray-500 hover:text-gray-700 whitespace-nowrap">
              üîí User b·ªã kh√≥a
            </button>
          </div>
        </div>

        <!-- Tab Contents -->
        <div id="allContent"></div>
        <div id="pendingContent" class="hidden"></div>
        <div id="reportsContent" class="hidden"></div>
        <div id="blockedContent" class="hidden"></div>
      </div>
    </main>
  </div>

  <!-- Post Detail Modal -->
  <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto">
      <div id="detailContent"></div>
    </div>
  </div>

  <!-- Warn User Modal -->
  <div id="warnModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full">
      <div class="p-6 border-b bg-yellow-500 text-white rounded-t-2xl">
        <h3 class="text-xl font-bold">‚ö†Ô∏è C·∫£nh b√°o ng∆∞·ªùi d√πng</h3>
      </div>
      <div class="p-6">
        <p id="warnUserInfo" class="mb-4 text-gray-600"></p>
        <label class="block text-gray-700 font-semibold mb-2">L√Ω do c·∫£nh b√°o</label>
        <textarea id="warnReason" rows="3" class="w-full px-4 py-2 border rounded-lg" placeholder="Nh·∫≠p l√Ω do c·∫£nh b√°o..."></textarea>
        <div class="flex gap-3 mt-6">
          <button onclick="closeWarnModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 font-semibold">H·ªßy</button>
          <button onclick="confirmWarn()" class="flex-1 bg-yellow-500 text-white py-3 rounded-lg hover:bg-yellow-600 font-semibold">G·ª≠i c·∫£nh b√°o</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    const token = localStorage.getItem('token');
    let selectedPosts = [];
    let currentWarnUser = null;
    let currentWarnPostId = null;
    let currentTab = 'all';

    const typeInfo = {
      find_match: { icon: '‚öΩ', name: 'T√¨m k√®o', color: 'bg-green-100 text-green-800' },
      tournament: { icon: 'üèÜ', name: 'Gi·∫£i ƒë·∫•u', color: 'bg-yellow-100 text-yellow-800' },
      share: { icon: 'üí¨', name: 'Chia s·∫ª', color: 'bg-purple-100 text-purple-800' }
    };

    const statusInfo = {
      active: { name: 'Ho·∫°t ƒë·ªông', color: 'bg-green-100 text-green-800' },
      pending: { name: 'Ch·ªù duy·ªát', color: 'bg-yellow-100 text-yellow-800' },
      rejected: { name: 'T·ª´ ch·ªëi', color: 'bg-red-100 text-red-800' },
      closed: { name: 'ƒê√£ ƒë√≥ng', color: 'bg-gray-100 text-gray-800' },
      deleted: { name: 'ƒê√£ x√≥a', color: 'bg-red-100 text-red-800' }
    };

    const reportReasons = {
      spam: 'Spam / Qu·∫£ng c√°o',
      inappropriate: 'N·ªôi dung kh√¥ng ph√π h·ª£p',
      fake: 'Th√¥ng tin gi·∫£ m·∫°o',
      harassment: 'Qu·∫•y r·ªëi / X√∫c ph·∫°m',
      other: 'L√Ω do kh√°c'
    };

    function showToast(message, type = 'success') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      const colors = { success: 'bg-green-500', error: 'bg-red-500', warning: 'bg-yellow-500' };
      toast.className = `${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg`;
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(() => toast.remove(), 3000);
    }

    function logout() {
      localStorage.clear();
      window.location.href = '../index.html';
    }

    function showTab(tab) {
      currentTab = tab;
      document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.className = 'tab-btn flex-1 py-3 px-4 text-center font-semibold text-gray-500 hover:text-gray-700 whitespace-nowrap';
      });
      document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).className = 
        'tab-btn flex-1 py-3 px-4 text-center font-semibold border-b-2 border-green-600 text-green-600 whitespace-nowrap';
      
      ['all', 'pending', 'reports', 'blocked'].forEach(t => {
        document.getElementById(`${t}Content`).className = t === tab ? '' : 'hidden';
      });
    }

    async function loadAll() {
      await loadStats();
      await loadAllPosts();
      await loadPendingPosts();
      await loadReportedPosts();
      await loadBlockedUsers();
    }

    async function loadStats() {
      try {
        const response = await fetch(`${API_URL}/community/admin/stats`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        
        document.getElementById('statTotal').textContent = data.totalPosts || 0;
        document.getElementById('statActive').textContent = data.activePosts || 0;
        document.getElementById('statPending').textContent = data.pendingPosts || 0;
        document.getElementById('statReports').textContent = data.pendingReports || 0;
        document.getElementById('statHighRisk').textContent = data.highRiskPosts || 0;
        document.getElementById('pendingCount').textContent = data.pendingPosts || 0;
        document.getElementById('reportsCount').textContent = data.pendingReports || 0;
      } catch (error) {
        console.error('Error:', error);
      }
    }

    async function loadAllPosts() {
      try {
        const response = await fetch(`${API_URL}/community/admin/all`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        renderAllPosts(data.posts || []);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function renderAllPosts(posts) {
      const container = document.getElementById('allContent');
      if (posts.length === 0) {
        container.innerHTML = '<div class="bg-white rounded-xl shadow p-8 text-center text-gray-500">Ch∆∞a c√≥ b√†i ƒëƒÉng n√†o</div>';
        return;
      }

      container.innerHTML = `
        <div class="bg-white rounded-xl shadow overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">B√†i ƒëƒÉng</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">T√°c gi·∫£</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Lo·∫°i</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">Tr·∫°ng th√°i</th>
                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-600">R·ªßi ro</th>
                <th class="px-4 py-3 text-center text-sm font-semibold text-gray-600">Thao t√°c</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              ${posts.map(post => {
                const type = typeInfo[post.type] || { icon: 'üìù', name: 'Kh√°c', color: 'bg-gray-100 text-gray-800' };
                const status = statusInfo[post.status] || statusInfo.active;
                const riskColor = (post.riskScore || 0) >= 60 ? 'text-red-600' : (post.riskScore || 0) >= 30 ? 'text-yellow-600' : 'text-green-600';
                const pendingReports = post.reports?.filter(r => r.status === 'pending').length || 0;
                
                return `
                  <tr class="hover:bg-gray-50">
                    <td class="px-4 py-3">
                      <p class="font-semibold text-gray-800 truncate max-w-xs">${post.title}</p>
                      <p class="text-xs text-gray-500">${new Date(post.createdAt).toLocaleDateString('vi-VN')}</p>
                    </td>
                    <td class="px-4 py-3">
                      <p class="text-sm">${post.author?.name || 'N/A'}</p>
                    </td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 rounded-full text-xs font-semibold ${type.color}">${type.icon} ${type.name}</span>
                    </td>
                    <td class="px-4 py-3">
                      <span class="px-2 py-1 rounded-full text-xs font-semibold ${status.color}">${status.name}</span>
                      ${pendingReports > 0 ? `<span class="ml-1 px-2 py-1 bg-red-100 text-red-800 rounded-full text-xs">üö®${pendingReports}</span>` : ''}
                    </td>
                    <td class="px-4 py-3">
                      <span class="font-semibold ${riskColor}">${post.riskScore || 0}%</span>
                    </td>
                    <td class="px-4 py-3">
                      <div class="flex justify-center gap-1">
                        <button onclick="viewPost('${post._id}')" class="p-2 bg-blue-100 text-blue-600 rounded hover:bg-blue-200" title="Xem">üëÅÔ∏è</button>
                        ${post.status !== 'deleted' ? `<button onclick="deletePost('${post._id}')" class="p-2 bg-red-100 text-red-600 rounded hover:bg-red-200" title="X√≥a">üóëÔ∏è</button>` : ''}
                      </div>
                    </td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    async function loadPendingPosts() {
      try {
        const response = await fetch(`${API_URL}/community/admin/pending`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        renderPendingPosts(data.posts || []);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function renderPendingPosts(posts) {
      const container = document.getElementById('pendingContent');
      if (posts.length === 0) {
        container.innerHTML = '<div class="bg-white rounded-xl shadow p-8 text-center text-gray-500">‚úÖ Kh√¥ng c√≥ b√†i ƒëƒÉng n√†o ch·ªù duy·ªát</div>';
        return;
      }

      container.innerHTML = `
        <div class="bg-white rounded-xl shadow p-4 mb-4 flex items-center gap-4">
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" class="w-5 h-5">
            <span class="font-semibold">Ch·ªçn t·∫•t c·∫£</span>
          </label>
          <div class="flex-1"></div>
          <span id="selectedCount" class="text-gray-500">ƒê√£ ch·ªçn: 0</span>
          <button onclick="bulkApprove()" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:opacity-50" id="btnBulkApprove" disabled>‚úÖ Duy·ªát</button>
          <button onclick="bulkReject()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 disabled:opacity-50" id="btnBulkReject" disabled>‚ùå T·ª´ ch·ªëi</button>
        </div>
        <div class="space-y-4">
          ${posts.map(post => {
            const riskColor = (post.riskScore || 0) >= 60 ? 'bg-red-100 text-red-800' : (post.riskScore || 0) >= 30 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
            return `
              <div class="bg-white rounded-xl shadow p-4 hover:shadow-lg">
                <div class="flex items-start gap-4">
                  <input type="checkbox" class="post-checkbox w-5 h-5 mt-1" data-id="${post._id}" onchange="updateSelection()">
                  <div class="flex-1">
                    <div class="flex items-center gap-2 mb-2">
                      <h3 class="font-bold text-gray-800">${post.title}</h3>
                      <span class="px-2 py-1 rounded text-xs font-semibold ${riskColor}">R·ªßi ro: ${post.riskScore || 0}%</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-2 line-clamp-2">${post.content}</p>
                    <div class="flex items-center gap-4 text-xs text-gray-500">
                      <span>üë§ ${post.author?.name || 'N/A'}</span>
                      <span>üìÖ ${new Date(post.createdAt).toLocaleString('vi-VN')}</span>
                    </div>
                    ${post.autoModerationDetails?.bannedWords?.length > 0 ? `
                      <div class="mt-2 p-2 bg-red-50 rounded text-xs text-red-700">
                        ‚ö†Ô∏è T·ª´ ng·ªØ: ${post.autoModerationDetails.bannedWords.join(', ')}
                      </div>
                    ` : ''}
                  </div>
                  <div class="flex flex-col gap-2">
                    <button onclick="viewPost('${post._id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm hover:bg-blue-200">üëÅÔ∏è Xem</button>
                    <button onclick="approvePost('${post._id}')" class="px-3 py-1 bg-green-100 text-green-700 rounded text-sm hover:bg-green-200">‚úÖ Duy·ªát</button>
                    <button onclick="rejectPost('${post._id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm hover:bg-red-200">‚ùå T·ª´ ch·ªëi</button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    async function loadReportedPosts() {
      try {
        const response = await fetch(`${API_URL}/community/admin/all?hasReports=true`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const data = await response.json();
        const reportedPosts = (data.posts || []).filter(p => p.reports?.some(r => r.status === 'pending'));
        renderReportedPosts(reportedPosts);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function renderReportedPosts(posts) {
      const container = document.getElementById('reportsContent');
      if (posts.length === 0) {
        container.innerHTML = '<div class="bg-white rounded-xl shadow p-8 text-center text-gray-500">‚úÖ Kh√¥ng c√≥ b√°o c√°o n√†o ch·ªù x·ª≠ l√Ω</div>';
        return;
      }

      container.innerHTML = `
        <div class="space-y-4">
          ${posts.map(post => {
            const pendingReports = post.reports?.filter(r => r.status === 'pending') || [];
            return `
              <div class="bg-white rounded-xl shadow p-4">
                <div class="flex items-start gap-4">
                  <div class="flex-1">
                    <h3 class="font-bold text-gray-800 mb-2">${post.title}</h3>
                    <p class="text-gray-600 text-sm mb-3">${post.content.substring(0, 100)}...</p>
                    <div class="space-y-2">
                      ${pendingReports.map(r => `
                        <div class="flex items-center gap-2 p-2 bg-red-50 rounded text-sm">
                          <span class="px-2 py-1 bg-red-200 text-red-800 rounded text-xs">${reportReasons[r.reason] || r.reason}</span>
                          ${r.description ? `<span class="text-gray-600">${r.description}</span>` : ''}
                        </div>
                      `).join('')}
                    </div>
                  </div>
                  <div class="flex flex-col gap-2">
                    <button onclick="viewPost('${post._id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded text-sm">üëÅÔ∏è Xem</button>
                    <button onclick="dismissReports('${post._id}')" class="px-3 py-1 bg-gray-100 text-gray-700 rounded text-sm">‚úì B·ªè qua</button>
                    <button onclick="deletePost('${post._id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded text-sm">üóëÔ∏è X√≥a</button>
                  </div>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }

    async function loadBlockedUsers() {
      try {
        const response = await fetch(`${API_URL}/community/admin/blocked-users`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const users = await response.json();
        document.getElementById('statBlocked').textContent = users.length;
        renderBlockedUsers(users);
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function renderBlockedUsers(users) {
      const container = document.getElementById('blockedContent');
      if (users.length === 0) {
        container.innerHTML = '<div class="bg-white rounded-xl shadow p-8 text-center text-gray-500">‚úÖ Kh√¥ng c√≥ ng∆∞·ªùi d√πng b·ªã kh√≥a</div>';
        return;
      }

      container.innerHTML = `
        <div class="bg-white rounded-xl shadow overflow-hidden">
          <table class="w-full">
            <thead class="bg-gray-50">
              <tr>
                <th class="px-6 py-3 text-left">Ng∆∞·ªùi d√πng</th>
                <th class="px-6 py-3 text-left">Email</th>
                <th class="px-6 py-3 text-left">L√Ω do</th>
                <th class="px-6 py-3 text-left">Ng√†y kh√≥a</th>
                <th class="px-6 py-3 text-center">Thao t√°c</th>
              </tr>
            </thead>
            <tbody class="divide-y">
              ${users.map(u => `
                <tr class="hover:bg-gray-50">
                  <td class="px-6 py-4 font-semibold">${u.name}</td>
                  <td class="px-6 py-4 text-gray-500">${u.email}</td>
                  <td class="px-6 py-4 text-red-600 text-sm">${u.blockedReason || 'Vi ph·∫°m quy ƒë·ªãnh'}</td>
                  <td class="px-6 py-4 text-gray-500 text-sm">${u.blockedAt ? new Date(u.blockedAt).toLocaleDateString('vi-VN') : '-'}</td>
                  <td class="px-6 py-4 text-center">
                    <button onclick="unblockUser('${u._id}')" class="px-4 py-2 bg-green-100 text-green-700 rounded-lg hover:bg-green-200">üîì M·ªü kh√≥a</button>
                  </td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        </div>
      `;
    }

    // Actions
    function toggleSelectAll() {
      const selectAll = document.getElementById('selectAll').checked;
      document.querySelectorAll('.post-checkbox').forEach(cb => cb.checked = selectAll);
      updateSelection();
    }

    function updateSelection() {
      selectedPosts = Array.from(document.querySelectorAll('.post-checkbox:checked')).map(cb => cb.dataset.id);
      document.getElementById('selectedCount').textContent = `ƒê√£ ch·ªçn: ${selectedPosts.length}`;
      document.getElementById('btnBulkApprove').disabled = selectedPosts.length === 0;
      document.getElementById('btnBulkReject').disabled = selectedPosts.length === 0;
    }

    async function bulkApprove() {
      if (!selectedPosts.length || !confirm(`Duy·ªát ${selectedPosts.length} b√†i ƒëƒÉng?`)) return;
      try {
        await fetch(`${API_URL}/community/admin/bulk-moderate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ postIds: selectedPosts, action: 'approve' })
        });
        showToast(`ƒê√£ duy·ªát ${selectedPosts.length} b√†i ƒëƒÉng`);
        loadAll();
      } catch (error) { showToast('L·ªói', 'error'); }
    }

    async function bulkReject() {
      if (!selectedPosts.length) return;
      const reason = prompt('Nh·∫≠p l√Ω do t·ª´ ch·ªëi:');
      if (!reason) return;
      try {
        await fetch(`${API_URL}/community/admin/bulk-moderate`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ postIds: selectedPosts, action: 'reject', reason })
        });
        showToast(`ƒê√£ t·ª´ ch·ªëi ${selectedPosts.length} b√†i ƒëƒÉng`);
        loadAll();
      } catch (error) { showToast('L·ªói', 'error'); }
    }

    async function approvePost(id) {
      try {
        await fetch(`${API_URL}/community/admin/${id}/moderate`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ action: 'approve' })
        });
        showToast('ƒê√£ duy·ªát b√†i ƒëƒÉng');
        loadAll();
      } catch (error) { showToast('L·ªói', 'error'); }
    }

    async function rejectPost(id) {
      const reason = prompt('Nh·∫≠p l√Ω do t·ª´ ch·ªëi:');
      if (!reason) return;
      try {
        await fetch(`${API_URL}/community/admin/${id}/moderate`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ action: 'reject', reason })
        });
        showToast('ƒê√£ t·ª´ ch·ªëi b√†i ƒëƒÉng');
        loadAll();
      } catch (error) { showToast('L·ªói', 'error'); }
    }

    async function deletePost(id) {
      if (!confirm('X√≥a b√†i ƒëƒÉng n√†y?')) return;
      try {
        await fetch(`${API_URL}/community/admin/${id}`, {
          method: 'DELETE',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        showToast('ƒê√£ x√≥a b√†i ƒëƒÉng');
        closeDetailModal();
        loadAll();
      } catch (error) { showToast('L·ªói', 'error'); }
    }

    async function dismissReports(postId) {
      try {
        const response = await fetch(`${API_URL}/community/${postId}`);
        const post = await response.json();
        const pendingReports = post.reports?.filter(r => r.status === 'pending') || [];
        
        for (const report of pendingReports) {
          await fetch(`${API_URL}/community/admin/${postId}/report`, {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ reportId: report._id, action: 'dismiss' })
          });
        }
        showToast('ƒê√£ b·ªè qua b√°o c√°o');
        loadAll();
      } catch (error) { showToast('L·ªói', 'error'); }
    }

    async function unblockUser(userId) {
      if (!confirm('M·ªü kh√≥a t√†i kho·∫£n n√†y?')) return;
      try {
        await fetch(`${API_URL}/community/admin/unblock-user/${userId}`, {
          method: 'PATCH',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        showToast('ƒê√£ m·ªü kh√≥a t√†i kho·∫£n');
        loadAll();
      } catch (error) { showToast('L·ªói', 'error'); }
    }

    async function viewPost(id) {
      try {
        const response = await fetch(`${API_URL}/community/${id}`);
        const post = await response.json();
        const type = typeInfo[post.type] || { icon: 'üìù', name: 'Kh√°c', color: 'bg-gray-100 text-gray-800' };
        const status = statusInfo[post.status] || statusInfo.active;
        const riskColor = (post.riskScore || 0) >= 60 ? 'bg-red-100 text-red-800' : (post.riskScore || 0) >= 30 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800';
        
        document.getElementById('detailContent').innerHTML = `
          <div class="p-6 border-b bg-gray-50">
            <div class="flex justify-between items-start">
              <div class="flex items-center gap-2">
                <span class="px-3 py-1 rounded-full text-sm font-semibold ${type.color}">${type.icon} ${type.name}</span>
                <span class="px-3 py-1 rounded-full text-sm font-semibold ${status.color}">${status.name}</span>
                <span class="px-3 py-1 rounded-full text-sm font-semibold ${riskColor}">R·ªßi ro: ${post.riskScore || 0}%</span>
              </div>
              <button onclick="closeDetailModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <h2 class="text-xl font-bold text-gray-800 mt-4">${post.title}</h2>
            <p class="text-gray-500 mt-2 text-sm">B·ªüi: ${post.author?.name || 'N/A'} ‚Ä¢ ${new Date(post.createdAt).toLocaleString('vi-VN')}</p>
          </div>
          <div class="p-6">
            <p class="text-gray-700 whitespace-pre-wrap mb-4">${post.content}</p>
            ${post.autoModerationDetails?.bannedWords?.length > 0 ? `
              <div class="bg-red-50 rounded-lg p-3 mb-4">
                <p class="text-sm text-red-700"><strong>‚ö†Ô∏è T·ª´ ng·ªØ vi ph·∫°m:</strong> ${post.autoModerationDetails.bannedWords.join(', ')}</p>
              </div>
            ` : ''}
            <div class="flex gap-2 text-sm text-gray-500 mb-4">
              <span>‚ù§Ô∏è ${post.likes?.length || 0}</span>
              <span>üí¨ ${post.comments?.length || 0}</span>
              <span>üëÅÔ∏è ${post.views || 0}</span>
            </div>
            <div class="flex gap-3">
              ${post.moderationStatus === 'pending' ? `
                <button onclick="approvePost('${post._id}'); closeDetailModal();" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">‚úÖ Duy·ªát</button>
                <button onclick="rejectPost('${post._id}'); closeDetailModal();" class="flex-1 bg-red-600 text-white py-2 rounded-lg hover:bg-red-700">‚ùå T·ª´ ch·ªëi</button>
              ` : ''}
              ${post.status !== 'deleted' ? `<button onclick="deletePost('${post._id}')" class="flex-1 bg-gray-600 text-white py-2 rounded-lg hover:bg-gray-700">üóëÔ∏è X√≥a</button>` : ''}
              <button onclick="openWarnModal('${post.author?._id}', '${post.author?.name}', '${post._id}')" class="flex-1 bg-yellow-500 text-white py-2 rounded-lg hover:bg-yellow-600">‚ö†Ô∏è C·∫£nh b√°o user</button>
            </div>
          </div>
        `;
        document.getElementById('detailModal').classList.remove('hidden');
      } catch (error) { showToast('L·ªói', 'error'); }
    }

    function closeDetailModal() {
      document.getElementById('detailModal').classList.add('hidden');
    }

    function openWarnModal(userId, userName, postId = null) {
      currentWarnUser = userId;
      currentWarnPostId = postId;
      document.getElementById('warnUserInfo').textContent = `G·ª≠i c·∫£nh b√°o ƒë·∫øn: ${userName}`;
      document.getElementById('warnReason').value = '';
      document.getElementById('warnModal').classList.remove('hidden');
    }

    function closeWarnModal() {
      document.getElementById('warnModal').classList.add('hidden');
    }

    async function confirmWarn() {
      const reason = document.getElementById('warnReason').value.trim();
      if (!reason) { showToast('Vui l√≤ng nh·∫≠p l√Ω do', 'warning'); return; }
      try {
        const response = await fetch(`${API_URL}/community/admin/warn-user`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ userId: currentWarnUser, reason, postId: currentWarnPostId })
        });
        const data = await response.json();
        showToast(data.isBlocked ? 'T√†i kho·∫£n ƒë√£ b·ªã kh√≥a' : `ƒê√£ g·ª≠i c·∫£nh b√°o (${data.violationCount}/3)`, data.isBlocked ? 'warning' : 'success');
        closeWarnModal();
        closeDetailModal();
        loadAll();
      } catch (error) { showToast('L·ªói', 'error'); }
    }

    // Init
    loadAll();
  </script>
</body>
</html>
