<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B√°o c√°o & Th·ªëng k√™ - Admin</title>
  <link rel="stylesheet" href="../css/tailwind-fallback.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .sidebar-link { transition: all 0.2s; }
    .sidebar-link:hover { background: rgba(255,255,255,0.1); transform: translateX(4px); }
    .sidebar-link.active { background: rgba(255,255,255,0.15); border-left: 3px solid #fbbf24; }
    .glass { background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); }
  </style>
</head>
<body class="bg-slate-50">
  <div class="flex h-screen">
    <!-- Sidebar - Dynamic -->
    <div id="admin-sidebar"></div>

    <main class="flex-1 overflow-y-auto">
      <!-- Header - Dynamic -->
      <div id="admin-header"></div>
      
      <div class="flex justify-end items-center gap-3 px-6 pt-4">
        <select id="filterType" onchange="changeFilterType()" class="px-4 py-2 border-2 border-slate-200 rounded-xl text-sm font-medium focus:border-green-500">
          <option value="all">T·∫•t c·∫£</option>
          <option value="day">Theo ng√†y</option>
          <option value="month">Theo th√°ng</option>
          <option value="year">Theo nƒÉm</option>
          <option value="range">Kho·∫£ng th·ªùi gian</option>
        </select>
        <div id="dayFilter" class="hidden">
          <input type="date" id="filterDay" onchange="loadReports()" class="px-4 py-2 border-2 border-slate-200 rounded-xl text-sm">
        </div>
        <div id="monthFilter" class="hidden flex gap-2">
          <select id="filterMonth" onchange="loadReports()" class="px-3 py-2 border-2 border-slate-200 rounded-xl text-sm">
            <option value="1">Th√°ng 1</option><option value="2">Th√°ng 2</option><option value="3">Th√°ng 3</option>
            <option value="4">Th√°ng 4</option><option value="5">Th√°ng 5</option><option value="6">Th√°ng 6</option>
            <option value="7">Th√°ng 7</option><option value="8">Th√°ng 8</option><option value="9">Th√°ng 9</option>
            <option value="10">Th√°ng 10</option><option value="11">Th√°ng 11</option><option value="12">Th√°ng 12</option>
          </select>
          <select id="filterMonthYear" onchange="loadReports()" class="px-3 py-2 border-2 border-slate-200 rounded-xl text-sm"></select>
        </div>
        <div id="yearFilter" class="hidden">
          <select id="filterYear" onchange="loadReports()" class="px-4 py-2 border-2 border-slate-200 rounded-xl text-sm"></select>
        </div>
        <div id="rangeFilter" class="hidden flex gap-2">
          <input type="date" id="filterFrom" onchange="loadReports()" class="px-3 py-2 border-2 border-slate-200 rounded-xl text-sm">
          <span class="text-slate-400 self-center">‚Üí</span>
          <input type="date" id="filterTo" onchange="loadReports()" class="px-3 py-2 border-2 border-slate-200 rounded-xl text-sm">
        </div>
        <button onclick="exportReport()" class="px-4 py-2 bg-green-100 text-green-700 rounded-xl text-sm font-medium hover:bg-green-200">üì• Xu·∫•t b√°o c√°o</button>
      </div>
      <div class="p-6">
        <div class="grid grid-cols-4 gap-4 mb-6">
          <div class="bg-gradient-to-br from-green-500 to-emerald-600 rounded-2xl p-5 text-white">
            <p class="text-sm text-green-100">T·ªïng doanh thu</p>
            <p id="totalRevenue" class="text-3xl font-bold">0ƒë</p>
          </div>
          <div class="bg-white rounded-2xl p-5 border border-slate-100">
            <p class="text-sm text-slate-500">T·ªïng ƒë∆°n ƒë·∫∑t</p>
            <p id="totalBookings" class="text-2xl font-bold text-slate-800">0</p>
          </div>
          <div class="bg-white rounded-2xl p-5 border border-slate-100">
            <p class="text-sm text-slate-500">T·ª∑ l·ªá ho√†n th√†nh</p>
            <p id="completionRate" class="text-2xl font-bold text-blue-600">0%</p>
          </div>
          <div class="bg-white rounded-2xl p-5 border border-slate-100">
            <p class="text-sm text-slate-500">Kh√°ch h√†ng</p>
            <p id="totalCustomers" class="text-2xl font-bold text-purple-600">0</p>
          </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-2xl p-5 border border-slate-100">
            <h3 class="font-bold text-slate-800 mb-4">Doanh thu theo th√°ng</h3>
            <canvas id="monthlyChart" height="200"></canvas>
          </div>
          <div class="bg-white rounded-2xl p-5 border border-slate-100">
            <h3 class="font-bold text-slate-800 mb-4">ƒê·∫∑t s√¢n theo lo·∫°i</h3>
            <canvas id="typeChart" height="200"></canvas>
          </div>
        </div>

        <div class="grid lg:grid-cols-2 gap-6">
          <div class="bg-white rounded-2xl p-5 border border-slate-100">
            <h3 class="font-bold text-slate-800 mb-4">Top s√¢n ƒë∆∞·ª£c ƒë·∫∑t nhi·ªÅu</h3>
            <div id="topFields" class="space-y-3"></div>
          </div>
          <div class="bg-white rounded-2xl p-5 border border-slate-100">
            <h3 class="font-bold text-slate-800 mb-4">Khung gi·ªù ph·ªï bi·∫øn</h3>
            <canvas id="hourChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    const token = localStorage.getItem('token');
    let allBookings = [];
    let allFields = [];
    let allUsers = [];
    let monthlyChart, typeChart, hourChart;
    
    function logout() { localStorage.clear(); window.location.href = '../index.html'; }
    
    // Kh·ªüi t·∫°o b·ªô l·ªçc nƒÉm
    function initFilters() {
      const currentYear = new Date().getFullYear();
      const currentMonth = new Date().getMonth() + 1;
      const years = [];
      for (let y = currentYear; y >= currentYear - 5; y--) years.push(y);
      
      document.getElementById('filterYear').innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
      document.getElementById('filterMonthYear').innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
      document.getElementById('filterMonth').value = currentMonth;
      
      // Set default dates
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('filterDay').value = today;
      document.getElementById('filterFrom').value = new Date(currentYear, 0, 1).toISOString().split('T')[0];
      document.getElementById('filterTo').value = today;
    }
    
    function changeFilterType() {
      const type = document.getElementById('filterType').value;
      document.getElementById('dayFilter').classList.add('hidden');
      document.getElementById('monthFilter').classList.add('hidden');
      document.getElementById('yearFilter').classList.add('hidden');
      document.getElementById('rangeFilter').classList.add('hidden');
      
      if (type === 'day') document.getElementById('dayFilter').classList.remove('hidden');
      else if (type === 'month') document.getElementById('monthFilter').classList.remove('hidden');
      else if (type === 'year') document.getElementById('yearFilter').classList.remove('hidden');
      else if (type === 'range') document.getElementById('rangeFilter').classList.remove('hidden');
      
      loadReports();
    }
    
    function filterBookings(bookings) {
      const type = document.getElementById('filterType').value;
      if (type === 'all') return bookings;
      
      return bookings.filter(b => {
        const date = new Date(b.date);
        if (type === 'day') {
          const filterDate = document.getElementById('filterDay').value;
          return b.date === filterDate;
        } else if (type === 'month') {
          const month = parseInt(document.getElementById('filterMonth').value);
          const year = parseInt(document.getElementById('filterMonthYear').value);
          return date.getMonth() + 1 === month && date.getFullYear() === year;
        } else if (type === 'year') {
          const year = parseInt(document.getElementById('filterYear').value);
          return date.getFullYear() === year;
        } else if (type === 'range') {
          const from = document.getElementById('filterFrom').value;
          const to = document.getElementById('filterTo').value;
          return b.date >= from && b.date <= to;
        }
        return true;
      });
    }
    
    async function loadReports() {
      try {
        // Ch·ªâ fetch l·∫ßn ƒë·∫ßu
        if (allBookings.length === 0) {
          const [bookingsRes, fieldsRes, usersRes] = await Promise.all([
            fetch(`${API_URL}/bookings`, { headers: { 'Authorization': `Bearer ${token}` } }),
            fetch(`${API_URL}/fields`),
            fetch(`${API_URL}/users`, { headers: { 'Authorization': `Bearer ${token}` } }).catch(() => ({ ok: false }))
          ]);
          
          allBookings = await bookingsRes.json();
          allFields = await fieldsRes.json();
          allUsers = usersRes.ok ? await usersRes.json() : [];
        }
        
        const filteredBookings = filterBookings(allBookings);
        const completed = filteredBookings.filter(b => b.status !== 'cancelled');
        const totalRev = completed.reduce((s, b) => s + b.totalPrice, 0);
        
        document.getElementById('totalRevenue').textContent = totalRev.toLocaleString() + 'ƒë';
        document.getElementById('totalBookings').textContent = filteredBookings.length;
        document.getElementById('completionRate').textContent = filteredBookings.length ? Math.round(filteredBookings.filter(b => b.status === 'completed').length / filteredBookings.length * 100) + '%' : '0%';
        document.getElementById('totalCustomers').textContent = allUsers.filter(u => u.role === 'customer').length;
        
        // Destroy old charts
        if (monthlyChart) monthlyChart.destroy();
        if (typeChart) typeChart.destroy();
        if (hourChart) hourChart.destroy();
        
        drawMonthlyChart(completed);
        drawTypeChart(completed);
        drawHourChart(completed);
        displayTopFields(completed, allFields);
      } catch (e) { console.error(e); }
    }
    
    function drawMonthlyChart(bookings) {
      const ctx = document.getElementById('monthlyChart').getContext('2d');
      const filterType = document.getElementById('filterType').value;
      
      let labels, data;
      if (filterType === 'day' || filterType === 'range') {
        // Hi·ªÉn th·ªã theo ng√†y
        const days = {};
        bookings.forEach(b => {
          const d = b.date;
          days[d] = (days[d] || 0) + b.totalPrice;
        });
        const sortedDays = Object.keys(days).sort();
        labels = sortedDays.map(d => new Date(d).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' }));
        data = sortedDays.map(d => days[d] / 1000000);
      } else {
        // Hi·ªÉn th·ªã theo th√°ng
        const months = ['T1', 'T2', 'T3', 'T4', 'T5', 'T6', 'T7', 'T8', 'T9', 'T10', 'T11', 'T12'];
        labels = months;
        data = months.map((_, i) => bookings.filter(b => new Date(b.date).getMonth() === i).reduce((s, b) => s + b.totalPrice, 0) / 1000000);
      }
      
      monthlyChart = new Chart(ctx, { 
        type: 'bar', 
        data: { labels, datasets: [{ label: 'Doanh thu (tri·ªáu)', data, backgroundColor: '#22c55e' }] }, 
        options: { responsive: true, plugins: { legend: { display: false } } } 
      });
    }
    
    function drawTypeChart(bookings) {
      const ctx = document.getElementById('typeChart').getContext('2d');
      const types = { '5vs5': 0, '7vs7': 0, '11vs11': 0 };
      bookings.forEach(b => { if (b.field?.type) types[b.field.type]++; });
      typeChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['S√¢n 5', 'S√¢n 7', 'S√¢n 11'], datasets: [{ data: Object.values(types), backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b'] }] }, options: { responsive: true, plugins: { legend: { position: 'bottom' } } } });
    }
    
    function drawHourChart(bookings) {
      const ctx = document.getElementById('hourChart').getContext('2d');
      const hours = {};
      bookings.forEach(b => { const h = b.startTime?.split(':')[0]; if (h) hours[h] = (hours[h] || 0) + 1; });
      const labels = Object.keys(hours).sort((a, b) => a - b).map(h => h + ':00');
      const data = labels.map(l => hours[l.split(':')[0]]);
      hourChart = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'S·ªë l∆∞·ª£t ƒë·∫∑t', data, backgroundColor: '#3b82f6' }] }, options: { responsive: true, plugins: { legend: { display: false } } } });
    }
    
    function displayTopFields(bookings, fields) {
      const counts = {};
      bookings.forEach(b => { if (b.field?._id) counts[b.field._id] = (counts[b.field._id] || 0) + 1; });
      const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]).slice(0, 5);
      document.getElementById('topFields').innerHTML = sorted.map(([id, count], i) => {
        const field = fields.find(f => f._id === id);
        return `<div class="flex items-center justify-between p-3 bg-slate-50 rounded-xl"><div class="flex items-center gap-3"><span class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center font-bold text-green-700">${i + 1}</span><span class="font-medium text-slate-800">${field?.name || 'N/A'}</span></div><span class="text-slate-600">${count} l∆∞·ª£t</span></div>`;
      }).join('') || '<p class="text-slate-400 text-center">Ch∆∞a c√≥ d·ªØ li·ªáu</p>';
    }
    
    function exportReport() {
      const filterType = document.getElementById('filterType').value;
      let period = 'T·∫•t c·∫£ th·ªùi gian';
      if (filterType === 'day') period = document.getElementById('filterDay').value;
      else if (filterType === 'month') period = `Th√°ng ${document.getElementById('filterMonth').value}/${document.getElementById('filterMonthYear').value}`;
      else if (filterType === 'year') period = `NƒÉm ${document.getElementById('filterYear').value}`;
      else if (filterType === 'range') period = `${document.getElementById('filterFrom').value} - ${document.getElementById('filterTo').value}`;
      
      const revenue = document.getElementById('totalRevenue').textContent;
      const bookings = document.getElementById('totalBookings').textContent;
      const rate = document.getElementById('completionRate').textContent;
      
      const content = `B√ÅO C√ÅO TH·ªêNG K√ä - S√ÇN B√ìNG TH√ÄNH TRUNG M10
========================================
Th·ªùi gian: ${period}
Ng√†y xu·∫•t: ${new Date().toLocaleString('vi-VN')}

T·ªîNG QUAN:
- T·ªïng doanh thu: ${revenue}
- T·ªïng ƒë∆°n ƒë·∫∑t: ${bookings}
- T·ª∑ l·ªá ho√†n th√†nh: ${rate}
========================================`;
      
      const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `bao-cao-${new Date().toISOString().split('T')[0]}.txt`;
      a.click();
    }
    
    // Ki·ªÉm tra quy·ªÅn - ch·ªâ admin m·ªõi ƒë∆∞·ª£c truy c·∫≠p
    const user = JSON.parse(localStorage.getItem('user') || '{}');
    if (!token || user.role !== 'admin') {
      alert('Ch·ªâ Admin m·ªõi c√≥ quy·ªÅn truy c·∫≠p trang B√°o c√°o!');
      window.location.href = 'index.html';
    } else {
      initFilters();
      loadReports();
    }
  </script>
  <script src="components/sidebar.js"></script>
  <script>
    renderAdminSidebar('reports');
    renderAdminHeader('B√°o c√°o & Th·ªëng k√™', 'Ph√¢n t√≠ch ho·∫°t ƒë·ªông kinh doanh');
  </script>
</body>
</html>
