<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quáº£n lÃ½ TÃ i chÃ­nh - Admin</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-green-800 text-white">
      <div class="p-6">
        <h1 class="text-2xl font-bold">âš½ Admin Panel</h1>
      </div>
      <nav class="mt-6">
        <a href="index.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">ğŸ“Š</span> Dashboard
        </a>
        <a href="fields.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">âš½</span> Quáº£n lÃ½ sÃ¢n
        </a>
        <a href="bookings.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">ğŸ“…</span> Quáº£n lÃ½ lá»‹ch Ä‘áº·t
        </a>
        <a href="customers.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">ğŸ‘¥</span> Quáº£n lÃ½ khÃ¡ch hÃ ng
        </a>
        <a href="revenue.html" class="flex items-center px-6 py-3 bg-green-700 border-l-4 border-white">
          <span class="mr-3">ğŸ’°</span> Quáº£n lÃ½ tÃ i chÃ­nh
        </a>
        <a href="inventory.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">ğŸ“¦</span> Quáº£n lÃ½ kho
        </a>
        <a href="promotions.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">ğŸ</span> Quáº£n lÃ½ khuyáº¿n mÃ£i
        </a>
        <a href="staff.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">ğŸ‘”</span> Quáº£n lÃ½ nhÃ¢n viÃªn
        </a>
        <a href="reports.html" class="flex items-center px-6 py-3 hover:bg-green-700">
          <span class="mr-3">ğŸ“ˆ</span> BÃ¡o cÃ¡o & Thá»‘ng kÃª
        </a>
        <a href="../index.html" class="flex items-center px-6 py-3 hover:bg-green-700 mt-4 border-t border-green-700">
          <span class="mr-3">ğŸ </span> Vá» trang chá»§
        </a>
        <a href="#" onclick="logout()" class="flex items-center px-6 py-3 hover:bg-red-700">
          <span class="mr-3">ğŸšª</span> ÄÄƒng xuáº¥t
        </a>
      </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 overflow-y-auto">
      <header class="bg-white shadow-sm">
        <div class="px-8 py-4">
          <h2 class="text-2xl font-bold text-gray-800">Quáº£n lÃ½ TÃ i chÃ­nh</h2>
        </div>
      </header>

      <div class="p-8">
        <!-- Time Filter -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
          <div class="grid md:grid-cols-4 gap-4">
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Tá»« ngÃ y</label>
              <input type="date" id="fromDate" onchange="updateCharts()" class="w-full px-4 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Äáº¿n ngÃ y</label>
              <input type="date" id="toDate" onchange="updateCharts()" class="w-full px-4 py-2 border rounded-lg">
            </div>
            <div>
              <label class="block text-gray-700 font-semibold mb-2">Ká»³ bÃ¡o cÃ¡o</label>
              <select id="reportPeriod" onchange="setQuickPeriod()" class="w-full px-4 py-2 border rounded-lg">
                <option value="custom">TÃ¹y chá»n</option>
                <option value="today">HÃ´m nay</option>
                <option value="week">7 ngÃ y qua</option>
                <option value="month">ThÃ¡ng nÃ y</option>
                <option value="year">NÄƒm nÃ y</option>
              </select>
            </div>
            <div class="flex items-end">
              <button onclick="exportReport()" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                ğŸ“Š Xuáº¥t bÃ¡o cÃ¡o
              </button>
            </div>
          </div>
        </div>

        <!-- Revenue Stats -->
        <div class="grid md:grid-cols-4 gap-6 mb-6">
          <div class="bg-white rounded-lg shadow p-6">
            <p class="text-gray-500 text-sm">Doanh thu hÃ´m nay</p>
            <p class="text-3xl font-bold text-green-600" id="todayRevenue">0Ä‘</p>
            <p class="text-sm text-gray-400 mt-1" id="todayChange">+0%</p>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <p class="text-gray-500 text-sm">Doanh thu thÃ¡ng</p>
            <p class="text-3xl font-bold text-blue-600" id="monthRevenue">0Ä‘</p>
            <p class="text-sm text-gray-400 mt-1" id="monthChange">+0%</p>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <p class="text-gray-500 text-sm">Doanh thu nÄƒm</p>
            <p class="text-3xl font-bold text-purple-600" id="yearRevenue">0Ä‘</p>
            <p class="text-sm text-gray-400 mt-1" id="yearChange">+0%</p>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <p class="text-gray-500 text-sm">Trung bÃ¬nh/ngÃ y</p>
            <p class="text-3xl font-bold text-orange-600" id="avgRevenue">0Ä‘</p>
            <p class="text-sm text-gray-400 mt-1">30 ngÃ y qua</p>
          </div>
        </div>

        <!-- Charts -->
        <div class="grid md:grid-cols-2 gap-6 mb-6">
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Doanh thu theo thá»i gian</h3>
            <canvas id="revenueTimeChart"></canvas>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">Doanh thu theo loáº¡i sÃ¢n</h3>
            <canvas id="revenueFieldChart"></canvas>
          </div>
        </div>

        <!-- Revenue by Field -->
        <div class="bg-white rounded-lg shadow">
          <div class="p-6 border-b">
            <h3 class="text-lg font-bold text-gray-800">Doanh thu theo sÃ¢n</h3>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-gray-50">
                <tr>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">TÃªn sÃ¢n</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Loáº¡i</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sá»‘ láº§n Ä‘áº·t</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Doanh thu</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">% Tá»•ng</th>
                </tr>
              </thead>
              <tbody id="fieldRevenueTable" class="divide-y divide-gray-200">
                <tr>
                  <td colspan="5" class="px-6 py-4 text-center text-gray-500">Äang táº£i...</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    const token = localStorage.getItem('token');
    let allBookings = [];
    let allFields = [];
    let revenueChart, fieldChart;

    function logout() {
      localStorage.clear();
      window.location.href = '../index.html';
    }

    async function loadData() {
      try {
        const [bookingsResponse, fieldsResponse] = await Promise.all([
          fetch(`${API_URL}/bookings`, { headers: { 'Authorization': `Bearer ${token}` } }),
          fetch(`${API_URL}/fields`)
        ]);
        
        allBookings = await bookingsResponse.json();
        allFields = await fieldsResponse.json();

        const today = new Date();
        const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
        document.getElementById('fromDate').value = firstDay.toISOString().split('T')[0];
        document.getElementById('toDate').value = today.toISOString().split('T')[0];

        updateStats();
        updateCharts();
        updateFieldRevenueTable();
      } catch (error) {
        console.error('Error:', error);
      }
    }

    function updateStats() {
      const today = new Date();
      const thisMonth = today.getMonth();
      const thisYear = today.getFullYear();

      const todayBookings = allBookings.filter(b => 
        new Date(b.date).toDateString() === today.toDateString() && b.status !== 'cancelled'
      );
      const todayRevenue = todayBookings.reduce((sum, b) => sum + b.totalPrice, 0);

      const monthBookings = allBookings.filter(b => 
        new Date(b.date).getMonth() === thisMonth && 
        new Date(b.date).getFullYear() === thisYear &&
        b.status !== 'cancelled'
      );
      const monthRevenue = monthBookings.reduce((sum, b) => sum + b.totalPrice, 0);

      const yearBookings = allBookings.filter(b => 
        new Date(b.date).getFullYear() === thisYear && b.status !== 'cancelled'
      );
      const yearRevenue = yearBookings.reduce((sum, b) => sum + b.totalPrice, 0);

      const last30Days = allBookings.filter(b => {
        const bookingDate = new Date(b.date);
        const daysDiff = (today - bookingDate) / (1000 * 60 * 60 * 24);
        return daysDiff <= 30 && b.status !== 'cancelled';
      });
      const avgRevenue = last30Days.reduce((sum, b) => sum + b.totalPrice, 0) / 30;

      document.getElementById('todayRevenue').textContent = todayRevenue.toLocaleString() + 'Ä‘';
      document.getElementById('monthRevenue').textContent = monthRevenue.toLocaleString() + 'Ä‘';
      document.getElementById('yearRevenue').textContent = yearRevenue.toLocaleString() + 'Ä‘';
      document.getElementById('avgRevenue').textContent = Math.round(avgRevenue).toLocaleString() + 'Ä‘';
    }

    function updateCharts() {
      const fromDate = new Date(document.getElementById('fromDate').value);
      const toDate = new Date(document.getElementById('toDate').value);

      const filteredBookings = allBookings.filter(b => {
        const bookingDate = new Date(b.date);
        return bookingDate >= fromDate && bookingDate <= toDate && b.status !== 'cancelled';
      });

      drawRevenueTimeChart(filteredBookings, fromDate, toDate);
      drawRevenueFieldChart(filteredBookings);
    }

    function drawRevenueTimeChart(bookings, fromDate, toDate) {
      const ctx = document.getElementById('revenueTimeChart').getContext('2d');
      
      if (revenueChart) revenueChart.destroy();

      const revenueByDate = {};
      const currentDate = new Date(fromDate);
      
      while (currentDate <= toDate) {
        const dateStr = currentDate.toISOString().split('T')[0];
        revenueByDate[dateStr] = 0;
        currentDate.setDate(currentDate.getDate() + 1);
      }

      bookings.forEach(booking => {
        const dateStr = booking.date.split('T')[0];
        if (revenueByDate.hasOwnProperty(dateStr)) {
          revenueByDate[dateStr] += booking.totalPrice;
        }
      });

      const labels = Object.keys(revenueByDate).map(date => 
        new Date(date).toLocaleDateString('vi-VN', { day: '2-digit', month: '2-digit' })
      );
      const data = Object.values(revenueByDate).map(revenue => revenue / 1000);

      revenueChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Doanh thu (nghÃ¬n Ä‘á»“ng)',
            data,
            borderColor: 'rgb(34, 197, 94)',
            backgroundColor: 'rgba(34, 197, 94, 0.1)',
            tension: 0.4,
            fill: true
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    }

    function drawRevenueFieldChart(bookings) {
      const ctx = document.getElementById('revenueFieldChart').getContext('2d');
      
      if (fieldChart) fieldChart.destroy();

      const revenueByType = { '5vs5': 0, '7vs7': 0, '11vs11': 0 };
      
      bookings.forEach(booking => {
        if (booking.field && booking.field.type) {
          revenueByType[booking.field.type] += booking.totalPrice;
        }
      });

      fieldChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['SÃ¢n 5 ngÆ°á»i', 'SÃ¢n 7 ngÆ°á»i', 'SÃ¢n 11 ngÆ°á»i'],
          datasets: [{
            data: [revenueByType['5vs5'], revenueByType['7vs7'], revenueByType['11vs11']],
            backgroundColor: ['#22c55e', '#3b82f6', '#f59e0b']
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    }

    function updateFieldRevenueTable() {
      const tbody = document.getElementById('fieldRevenueTable');
      
      const fieldRevenue = {};
      allFields.forEach(field => {
        fieldRevenue[field._id] = { field, bookings: 0, revenue: 0 };
      });

      allBookings.forEach(booking => {
        if (booking.field && booking.status !== 'cancelled') {
          const fieldId = booking.field._id;
          if (fieldRevenue[fieldId]) {
            fieldRevenue[fieldId].bookings++;
            fieldRevenue[fieldId].revenue += booking.totalPrice;
          }
        }
      });

      const totalRevenue = Object.values(fieldRevenue).reduce((sum, f) => sum + f.revenue, 0);
      const sortedFields = Object.values(fieldRevenue).sort((a, b) => b.revenue - a.revenue);

      const typeMap = { '5vs5': 'SÃ¢n 5', '7vs7': 'SÃ¢n 7', '11vs11': 'SÃ¢n 11' };

      tbody.innerHTML = sortedFields.map(item => {
        const percentage = totalRevenue > 0 ? (item.revenue / totalRevenue * 100).toFixed(1) : 0;
        return `
          <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 font-semibold">${item.field.name}</td>
            <td class="px-6 py-4">${typeMap[item.field.type] || item.field.type}</td>
            <td class="px-6 py-4">${item.bookings}</td>
            <td class="px-6 py-4 font-semibold text-green-600">${item.revenue.toLocaleString()}Ä‘</td>
            <td class="px-6 py-4">${percentage}%</td>
          </tr>
        `;
      }).join('');
    }

    function setQuickPeriod() {
      const period = document.getElementById('reportPeriod').value;
      const today = new Date();
      let fromDate, toDate;

      switch (period) {
        case 'today':
          fromDate = toDate = today;
          break;
        case 'week':
          fromDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
          toDate = today;
          break;
        case 'month':
          fromDate = new Date(today.getFullYear(), today.getMonth(), 1);
          toDate = today;
          break;
        case 'year':
          fromDate = new Date(today.getFullYear(), 0, 1);
          toDate = today;
          break;
        default:
          return;
      }

      document.getElementById('fromDate').value = fromDate.toISOString().split('T')[0];
      document.getElementById('toDate').value = toDate.toISOString().split('T')[0];
      updateCharts();
    }

    function exportReport() {
      const fromDate = document.getElementById('fromDate').value;
      const toDate = document.getElementById('toDate').value;
      
      const filteredBookings = allBookings.filter(b => {
        const bookingDate = new Date(b.date);
        return bookingDate >= new Date(fromDate) && bookingDate <= new Date(toDate) && b.status !== 'cancelled';
      });

      const totalRevenue = filteredBookings.reduce((sum, b) => sum + b.totalPrice, 0);
      
      alert(`BÃ¡o cÃ¡o doanh thu\n\nTá»«: ${fromDate}\nÄáº¿n: ${toDate}\n\nTá»•ng Ä‘áº·t sÃ¢n: ${filteredBookings.length}\nTá»•ng doanh thu: ${totalRevenue.toLocaleString()}Ä‘`);
    }

    loadData();
  </script>
</body>
</html>
