<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Test Profile API</title>
  <style>
    body { font-family: Arial; padding: 20px; }
    button { padding: 10px 20px; margin: 5px; cursor: pointer; background: green; color: white; border: none; }
    .info { background: #f0f0f0; padding: 10px; margin: 10px 0; }
    .success { color: green; }
    .error { color: red; }
    pre { background: #f5f5f5; padding: 10px; overflow: auto; }
  </style>
</head>
<body>
  <h1>Test Profile API</h1>
  
  <div class="info">
    <h3>LocalStorage Info:</h3>
    <p>Token: <span id="tokenInfo">Checking...</span></p>
    <p>User: <span id="userInfo">Checking...</span></p>
  </div>
  
  <button onclick="testProfile()">Test Profile API</button>
  <button onclick="clearStorage()">Clear Storage</button>
  
  <div id="result"></div>

  <script>
    const API_URL = 'http://localhost:3000/api';
    
    // Check storage
    const token = localStorage.getItem('token');
    const user = localStorage.getItem('user');
    
    document.getElementById('tokenInfo').textContent = token ? 'Có (' + token.substring(0, 20) + '...)' : 'Không có';
    document.getElementById('userInfo').textContent = user ? user : 'Không có';
    
    if (!token) {
      document.getElementById('result').innerHTML = '<p class="error">⚠️ Chưa đăng nhập! Vui lòng đăng nhập trước.</p><a href="pages/login.html">Đăng nhập ngay</a>';
    }
    
    async function testProfile() {
      const result = document.getElementById('result');
      result.innerHTML = '<p>Testing profile API...</p>';
      
      if (!token) {
        result.innerHTML = '<p class="error">Không có token! Vui lòng đăng nhập.</p>';
        return;
      }
      
      try {
        console.log('Fetching profile with token:', token);
        const response = await fetch(`${API_URL}/users/profile`, {
          headers: {
            'Authorization': `Bearer ${token}`
          }
        });
        
        console.log('Response:', response);
        console.log('Status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        console.log('Profile data:', data);
        
        result.innerHTML = `
          <p class="success">✓ API Working!</p>
          <h3>Profile Data:</h3>
          <p><strong>Tên:</strong> ${data.name}</p>
          <p><strong>Email:</strong> ${data.email}</p>
          <p><strong>Phone:</strong> ${data.phone || 'N/A'}</p>
          <p><strong>Role:</strong> ${data.role}</p>
          <p><strong>ID:</strong> ${data._id}</p>
          <h3>Raw JSON:</h3>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
      } catch (error) {
        console.error('Error:', error);
        result.innerHTML = `
          <p class="error">✗ Error: ${error.message}</p>
          <p>Check console (F12) for details</p>
          <p>Có thể token đã hết hạn. Hãy đăng nhập lại.</p>
          <a href="pages/login.html">Đăng nhập lại</a>
        `;
      }
    }
    
    function clearStorage() {
      localStorage.clear();
      alert('Đã xóa storage!');
      location.reload();
    }
    
    // Auto test if logged in
    if (token) {
      testProfile();
    }
  </script>
</body>
</html>
